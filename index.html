<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Simulador NR-35 (V12.2: Avatar vis√≠vel)</title>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');

  :root{
    --cor-fundo:#eef2f6;--cor-painel:#fff;
    --cor-seguro:#2ecc71;--cor-critico:#e74c3c;--cor-atencao:#f1c40f;
    --cor-corda:#f39c12
  }
  body{font-family:'Inter',sans-serif;background:var(--cor-fundo);margin:0;padding:20px;height:100vh;overflow:hidden;display:flex;gap:20px}
  .sidebar{width:320px;background:var(--cor-painel);padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);display:flex;flex-direction:column;gap:15px;z-index:10;overflow-y:auto}
  h2{margin:0 0 5px;font-size:1.2rem;color:#2c3e50}.subtitle{font-size:.8rem;color:#7f8c8d;margin-bottom:10px}
  .control-group{border-bottom:1px solid #eee;padding-bottom:10px;margin-bottom:5px}
  label{font-size:.85rem;font-weight:600;color:#34495e;display:block;margin-bottom:5px}
  input[type="range"]{width:100%;margin:5px 0;cursor:pointer}
  .val-display{font-size:.9rem;font-weight:bold;color:#2980b9;float:right}
  .inline{display:flex;align-items:center;gap:8px}
  .hint{color:#7f8c8d;font-size:.75rem}

  .btn-action{padding:15px;border:none;border-radius:8px;font-weight:800;cursor:pointer;transition:transform .1s,background .2s;color:#fff;font-size:1rem;text-transform:uppercase;width:100%;margin-top:5px}
  .btn-simular{background:linear-gradient(135deg,#3498db,#2980b9);box-shadow:0 4px 0 #1c5a85}
  .btn-simular:hover{transform:translateY(-2px);box-shadow:0 6px 0 #1c5a85}
  .btn-simular:active{transform:translateY(2px);box-shadow:0 0 0 #1c5a85}
  .btn-reset{background:#95a5a6;box-shadow:0 4px 0 #7f8c8d;margin-top:10px}
  .btn-reset:hover{background:#7f8c8d}.btn-reset:active{transform:translateY(2px);box-shadow:0 0 0 #7f8c8d}

  /* KPIs */
  .kpi-panel{display:grid;grid-template-columns:1fr;gap:10px}
  .kpi-box{background:#f8f9fa;padding:10px;border-radius:6px;border-left:4px solid #ddd}
  .kpi-title{font-size:.65rem;text-transform:uppercase;color:#666;font-weight:700;margin-bottom:6px}
  .kpi-value{font-size:1.1rem;font-weight:900;color:#333}
  .kpi-status{font-size:.8rem;font-weight:800;margin-top:6px}
  .kpi-list{margin-top:8px}
  .kpi-row{display:flex;justify-content:space-between;font-size:.85rem;padding:4px 0;border-bottom:1px dashed #e5e7eb}
  .kpi-row:last-child{border-bottom:none}
  .ok{color:var(--cor-seguro)} .bad{color:var(--cor-critico)} .warn{color:var(--cor-atencao)}
  .tooltip{font-size:.72rem;color:#6b7280;margin-top:6px}

  /* Palco */
  .stage-container{flex:1;background:linear-gradient(to bottom,#87CEEB 0%,#e0f7fa 100%);border-radius:12px;position:relative;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.1);border:2px solid #fff}
  canvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2}

  #alert-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(231,76,60,.95);color:#fff;padding:30px 50px;border-radius:12px;font-size:2.0rem;font-weight:900;text-align:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .2s,transform .2s;box-shadow:0 20px 50px rgba(0,0,0,.4);border:4px solid #fff}
  .success-overlay{background:rgba(46,204,113,.95)!important}

  /* Modo B√°sico / Avan√ßado */
  .mode-tabs{display:flex;gap:8px;margin-bottom:6px}
  .mode-btn{flex:1;border:1px solid #d1d5db;background:#f9fafb;border-radius:8px;padding:8px 10px;font-weight:700;cursor:pointer}
  .mode-btn.active{background:#2563eb;color:#fff;border-color:#2563eb}
  .advanced-only{display:none;}
</style>
</head>
<body>
  <div class="sidebar">
    <div>
      <h2>‚öôÔ∏è Simulador NR-35</h2>
      <div class="subtitle">F√≠sica e Colis√£o em Tempo Real</div>
    </div>

    <!-- Tabs de modo -->
    <div class="mode-tabs">
      <button id="btn-basic" class="mode-btn active" type="button">B√°sico</button>
      <button id="btn-adv" class="mode-btn" type="button">Avan√ßado</button>
    </div>

    <div class="control-group">
      <label>1. Altura de Trabalho (H)</label>
      <span id="val-height" class="val-display">6.0m</span>
      <input type="range" id="input-height" min="2.0" max="10.0" step="0.5" value="6.0">
      <div class="hint">Altura dos p√©s em rela√ß√£o ao solo</div>
    </div>

    <!-- Altura do trabalhador (apenas Avan√ßado) -->
    <div class="control-group advanced-only" id="cg-worker">
      <label>2. Altura do Trabalhador</label>
      <span id="val-worker-height" class="val-display">1.65m</span>
      <input type="range" id="input-worker-height" min="1.50" max="2.10" step="0.05" value="1.65">
    </div>

    <div class="control-group">
      <label>3. Comp. Talabarte (L)</label>
      <span id="val-l" class="val-display">1.5m</span>
      <input type="range" id="input-l" min="1.0" max="2.0" step="0.1" value="1.5">
    </div>

    <div class="control-group">
      <label>4. Absorvedor de energia</label>
      <div class="inline">
        <input type="checkbox" id="chk-dec" checked>
        <label for="chk-dec" style="margin:0">Usar absorvedor</label>
      </div>
      <div class="inline" style="margin-top:6px">
        <input type="range" id="input-dec" min="0.00" max="1.80" step="0.05" value="1.20" style="flex:1">
        <span id="val-dec" class="val-display">1.20m</span>
      </div>
      <div id="dec-warning" class="hint">Opcional ‚Äî selecione conforme o equipamento a simular.</div>
    </div>

    <!-- Elasticidade (apenas Avan√ßado) -->
    <div class="control-group advanced-only" id="cg-elasticity">
        <label>5. Elasticidade do Sistema</label>
        <span id="val-elasticity" class="val-display">10%</span>
        <input type="range" id="input-elasticity" min="0" max="20" step="1" value="10">
        <div class="hint">Esticamento de talabarte/cinto (aplicado somente no modo Avan√ßado)</div>
    </div>

    <div class="control-group">
      <label>6. Posi√ß√£o da Ancoragem</label>
      <span id="val-anchor" class="val-display">Acima (FQ 0)</span>
      <input type="range" id="input-anchor" min="0" max="2" step="1" value="0">
      <div class="hint">0: Acima (FQ0) | 1: Cinto (FQ1) | 2: P√©s (FQ2)</div>
    </div>

    <!-- KPIs -->
    <div class="kpi-panel">
      <div class="kpi-box">
        <div class="kpi-title">MARGEM DE SEGURAN√áA (Dist√¢ncia dos p√©s ao solo)</div>
        <div class="kpi-value" id="kpi-zlq-res">-- m</div>
        <div class="kpi-status" id="kpi-status">--</div>
        <div class="tooltip" id="kpi-tip">Crit√©rio de refer√™ncia: Margem de Seguran√ßa ‚â• 1,0 m.</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">Componentes da ZLQ (conforme pr√°tica da NR-35 comentada)</div>
        <div class="kpi-list">
          <div class="kpi-row"><span>Dist√¢ncia de Queda Livre (DQ)</span><strong id="kpi-dq">-- m</strong></div>
          <div class="kpi-row"><span>Comprimento do Talabarte (L)</span><strong id="kpi-L">-- m</strong></div>
          <div class="kpi-row"><span>Absorvedor aberto (DEC)</span><strong id="kpi-dec">-- m</strong></div>
          <div class="kpi-row row-elasticity"><span>Elasticidade do Sistema (EL)</span><strong id="kpi-elasticity">-- m</strong></div>
          <div class="kpi-row"><span>Anel D ‚Üí p√© da pessoa (BODY)</span><strong id="kpi-body">-- m</strong></div>
          <div class="kpi-row"><span>Dist√¢ncia de seguran√ßa (S)</span><strong id="kpi-safe">1.00 m</strong></div>
          <div class="kpi-row"><span>DQ + DEC + EL (at√© o ponto de conex√£o)</span><strong id="kpi-qtotal">-- m</strong></div>
          <div class="kpi-row"><span>ZLQ necess√°ria (soma)</span><strong id="kpi-zlq-req">-- m</strong></div>
        </div>
      </div>
    </div>

    <button class="btn-action btn-simular" onclick="startSimulation()">‚ö†Ô∏è SIMULAR QUEDA</button>
    <button class="btn-action btn-reset" onclick="resetSimulation()">üîÑ RESETAR</button>
  </div>

  <div class="stage-container" id="stage">
    <div id="alert-overlay">COLIS√ÉO COM O SOLO!</div>
    <canvas id="simCanvas"></canvas>
  </div>

<script>
  /* F√≠sica/escala */
  const GRAVITY=0.6,DAMPING=0.96,PX_PER_METER=50;
  const SAFETY=1.0;

  /* Estado */
  const canvas=document.getElementById('simCanvas'); const ctx=canvas.getContext('2d');
  let running=false,crashed=false,finished=false;
  let world={groundY:0},anchor={x:0,y:0,fq:0},
      worker={x:0,y:0,vx:0,vy:0,startY:0, heightM: 1.65, heightPx: 0};
  let rope={lengthM:1.5};
  let config={workHeightM:6.0, useDecel:true, decelM:1.20, elasticityPerc:10};

  // Modo (B√°sico/Avan√ßado)
  let currentMode='basic';

  // Para sincronizar banner com c√°lculo
  let lastCalculatedMargin = 0;

  /* Inputs e KPIs */
  const inHeight=document.getElementById('input-height');
  const inWorkerHeight=document.getElementById('input-worker-height');
  const inLength=document.getElementById('input-l');
  const inAnchor=document.getElementById('input-anchor');
  const chkDec=document.getElementById('chk-dec');
  const inDec=document.getElementById('input-dec');
  const inElasticity=document.getElementById('input-elasticity');

  const lblHeight=document.getElementById('val-height');
  const lblWorkerHeight=document.getElementById('val-worker-height');
  const lblLength=document.getElementById('val-l');
  const lblAnchor=document.getElementById('val-anchor');
  const lblDec=document.getElementById('val-dec');

  const elDQ=document.getElementById('kpi-dq');
  const elL=document.getElementById('kpi-L');
  const elDec=document.getElementById('kpi-dec');
  const elElasticity=document.getElementById('kpi-elasticity');
  const elBody=document.getElementById('kpi-body');
  const elSafe=document.getElementById('kpi-safe');
  const elQTotal=document.getElementById('kpi-qtotal');
  const elZLQreq=document.getElementById('kpi-zlq-req');
  const elZLQres=document.getElementById('kpi-zlq-res');
  const elStatus=document.getElementById('kpi-status');

  const btnBasic=document.getElementById('btn-basic');
  const btnAdv=document.getElementById('btn-adv');
  const cgWorker=document.getElementById('cg-worker');
  const cgElasticity=document.getElementById('cg-elasticity');
  const rowsElasticity=document.querySelectorAll('.row-elasticity');

  /* Tabs de modo */
  btnBasic.addEventListener('click', ()=>{ setMode('basic'); });
  btnAdv.addEventListener('click', ()=>{ setMode('advanced'); });

  function setMode(mode){
    currentMode = mode;
    btnBasic.classList.toggle('active', mode==='basic');
    btnAdv.classList.toggle('active', mode==='advanced');

    const showAdv = (mode==='advanced');
    cgWorker.style.display = showAdv?'block':'none';
    cgElasticity.style.display = showAdv?'block':'none';
    rowsElasticity.forEach(r=> r.style.display = showAdv?'flex':'none');

    updateSettings();
  }

  function resize(){
    canvas.width=document.getElementById('stage').offsetWidth;
    canvas.height=document.getElementById('stage').offsetHeight;
    world.groundY=canvas.height-40;
    resetSimulation();
    drawScene(); // garante primeiro desenho
  }
  window.addEventListener('resize',resize);

  function updateSettings(){
    config.workHeightM=parseFloat(inHeight.value);
    worker.heightM=parseFloat(inWorkerHeight?.value || worker.heightM);
    rope.lengthM=parseFloat(inLength.value);
    anchor.fq=parseInt(inAnchor.value);
    config.useDecel=chkDec.checked;
    config.decelM=parseFloat(inDec.value);
    config.elasticityPerc=parseInt(inElasticity.value);

    lblHeight.innerText=config.workHeightM.toFixed(1)+"m";
    if (lblWorkerHeight) lblWorkerHeight.innerText=worker.heightM.toFixed(2)+"m";
    lblLength.innerText=rope.lengthM.toFixed(1)+"m";
    lblDec.innerText=config.decelM.toFixed(2)+"m";
    document.getElementById('val-elasticity')?.innerText=config.elasticityPerc+"%";
    lblAnchor.innerText=["Acima (FQ 0)","Cinto (FQ 1)","P√©s (FQ 2)"][anchor.fq];

    /* >>> CORRE√á√ÉO PRINCIPAL: escala correta do avatar */
    worker.heightPx = worker.heightM * PX_PER_METER;  // 1,65 m ‚âà 82,5 px

    if(!running){
      const feetY=world.groundY-(config.workHeightM*PX_PER_METER);
      worker.y=feetY-worker.heightPx; worker.x=canvas.width/2; worker.startY=worker.y;

      const bodyDist = getBodyDistance(worker.heightM);
      const dRingY=feetY - (bodyDist * PX_PER_METER);
      if(anchor.fq===0) anchor.y=dRingY-(1.5*PX_PER_METER);
      else if(anchor.fq===1) anchor.y=dRingY;
      else anchor.y=feetY;
      anchor.x=worker.x-20;
    }

    inDec.disabled = !config.useDecel;

    calcKPIs();
    if(!running) drawScene();
  }

  [inHeight,inWorkerHeight,inLength,inAnchor,chkDec,inDec,inElasticity]
  .forEach(el=>el.addEventListener('input',updateSettings));

  /* Simula√ß√£o */
  function loop(){
    if(!running) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(!crashed && !finished){
      worker.vy+=GRAVITY; worker.vx*=DAMPING; worker.vy*=DAMPING;
      worker.x+=worker.vx; worker.y+=worker.vy;
    }

    if((worker.y+worker.heightPx)>=world.groundY){
      if(!crashed && !finished){
        crashed=true; worker.y=world.groundY-worker.heightPx; worker.vy=0;
      }
    }

    const dRingY=worker.y + (worker.heightPx * 0.3);
    const dx=worker.x-anchor.x, dy=dRingY-anchor.y, dist=Math.hypot(dx,dy);

    const physDec = config.useDecel ? config.decelM : 0.0;
    const maxDistPx=(rope.lengthM + physDec)*PX_PER_METER;

    if(dist>maxDistPx && !crashed){
      const angle=Math.atan2(dy,dx);
      const pullX=Math.cos(angle)*maxDistPx+anchor.x;
      const pullY=Math.sin(angle)*maxDistPx+anchor.y;
      const k=0.08; worker.vx-=(worker.x-pullX)*k; worker.vy-=(dRingY-pullY)*k;

      if(Math.abs(worker.vy)<0.1 && Math.abs(worker.vx)<0.1 && !finished){
        finished=true;
      }
    }

    drawScene();
    requestAnimationFrame(loop);
  }

  /* Desenho */
  function drawScene(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawRulers();

    const platformY=worker.startY+worker.heightPx;
    ctx.beginPath(); ctx.moveTo(0,platformY); ctx.lineTo(canvas.width,platformY);
    ctx.strokeStyle="#bdc3c7"; ctx.lineWidth=4; ctx.setLineDash([10,10]); ctx.stroke(); ctx.setLineDash([]);
    ctx.fillStyle="#7f8c8d"; ctx.font="bold 12px Inter"; ctx.fillText("PLATAFORMA DE TRABALHO",10,platformY-5);

    ctx.fillStyle="#5d4037"; ctx.fillRect(0,world.groundY,canvas.width,canvas.height-world.groundY);
    ctx.fillStyle="#8d6e63"; ctx.fillRect(0,world.groundY,canvas.width,5);
    ctx.fillStyle="rgba(255,255,255,0.3)"; ctx.fillText("SOLO (N√çVEL 0)",canvas.width/2-40,world.groundY+25);

    const dRingY=worker.y + (worker.heightPx * 0.3);
    ctx.beginPath(); ctx.moveTo(anchor.x,anchor.y);
    const dx=worker.x-anchor.x, dy=dRingY-anchor.y, dist=Math.hypot(dx,dy);
    const ropePx=rope.lengthM*PX_PER_METER;

    if(dist<ropePx && !crashed && !finished){
      const slack=(ropePx-dist)*0.6;
      ctx.quadraticCurveTo(anchor.x+dx/2,anchor.y+dy+slack,worker.x,dRingY);
      ctx.strokeStyle=varGet('--cor-corda'); ctx.lineWidth=3;
    }else{
      ctx.lineTo(worker.x,dRingY);
      ctx.strokeStyle=(dist>ropePx)?"#c0392b":varGet('--cor-corda');
      ctx.lineWidth=(dist>ropePx)?2:3;
    }
    ctx.stroke();

    ctx.beginPath(); ctx.arc(anchor.x,anchor.y,6,0,Math.PI*2); ctx.fillStyle="#2980b9"; ctx.fill();

    ctx.save(); ctx.translate(worker.x,worker.y);
    if(crashed){ ctx.translate(0,worker.heightPx); ctx.rotate(-Math.PI/2); ctx.translate(0,-worker.heightPx); }
    else if(running){ ctx.rotate(worker.vx*0.05); }
    const wH = worker.heightPx;
    ctx.fillStyle="#3498db"; ctx.fillRect(-wH*0.15, wH*0.2, wH*0.3, wH*0.4);
    ctx.fillStyle="#2c3e50"; ctx.fillRect(-wH*0.16, wH*0.3, wH*0.32, wH*0.08);
    ctx.fillStyle="#34495e"; ctx.fillRect(-wH*0.12, wH*0.6, wH*0.1, wH*0.4); ctx.fillRect(wH*0.02, wH*0.6, wH*0.1, wH*0.4);
    ctx.fillStyle="#f1c40f"; ctx.beginPath(); ctx.arc(0,wH*0.1,wH*0.12,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#e74c3c"; ctx.beginPath(); ctx.arc(0,wH*0.08,wH*0.13,Math.PI,0); ctx.fill();
    ctx.restore();
  }
  function varGet(name){ return getComputedStyle(document.documentElement).getPropertyValue(name)||"#f39c12"; }
  function drawRulers(){
    const meters=Math.ceil(canvas.height/PX_PER_METER);
    ctx.strokeStyle="rgba(0,0,0,0.05)"; ctx.lineWidth=1;
    ctx.fillStyle="rgba(0,0,0,0.3)"; ctx.font="10px Inter";
    for(let i=0;i<=meters;i++){
      const y=world.groundY-(i*PX_PER_METER); if(y<0) break;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
      if(i>0) ctx.fillText(i+"m",canvas.width-30,y+3);
    }
  }

  /* Controle */
  function startSimulation(){
    if(running) return;
    updateSettings();
    running=true; crashed=false; finished=false;
    const el=document.getElementById('alert-overlay'); el.style.opacity=0; el.className='';

    const isSafe = lastCalculatedMargin >= 0;
    showBanner(isSafe ? "QUEDA AMPARADA" : "COLIS√ÉO COM O SOLO!", isSafe);

    loop();
  }
  function resetSimulation(){
    running=false; crashed=false; finished=false; worker.vx=0; worker.vy=0;
    document.getElementById('alert-overlay').style.opacity=0; updateSettings();
  }
  function showBanner(text, safe){
    const el=document.getElementById('alert-overlay');
    el.innerText=text; el.className=safe?"success-overlay":"";
    setTimeout(() => {
      el.style.opacity=1;
      el.style.transform="translate(-50%,-50%) scale(1.1)";
      setTimeout(()=>el.style.transform="translate(-50%,-50%) scale(1)",200);
    }, 800);
  }

  /* L√≥gica de c√°lculo */
  function getBodyDistance(workerHeight) {
    return workerHeight * 0.85; // dist√¢ncia D-ring ‚Üí p√©s (aprox.)
  }
  function calcDQ(fq, L, bodyDist){
    if (fq === 0) return 0.6;
    if (fq === 1) return L;
    if (fq === 2) return L + bodyDist;
    return 0;
  }
  function calcKPIs(){
    const L = rope.lengthM, H = config.workHeightM, FQ = anchor.fq, WORKER_H = worker.heightM;
    const BODY = getBodyDistance(WORKER_H);
    const DQ = calcDQ(FQ, L, BODY);

    const DECEL = config.useDecel ? config.decelM : 0.0;

    const EL = (currentMode === 'advanced') ? ((L + DECEL) * (config.elasticityPerc / 100)) : 0.0;

    const QTOTAL = +(DQ + DECEL + EL).toFixed(3);

    const ZLQreq = +(QTOTAL + BODY + SAFETY).toFixed(2);
    const MarginOfSafety = +(H - ZLQreq).toFixed(2);
    lastCalculatedMargin = MarginOfSafety;

    elDQ.innerText = DQ.toFixed(2)+" m";
    elL.innerText  = L.toFixed(2)+" m";
    elDec.innerText = DECEL.toFixed(2)+" m";
    elElasticity.innerText = EL.toFixed(2)+" m";
    elBody.innerText = BODY.toFixed(2)+" m";
    elSafe.innerText = SAFETY.toFixed(2)+" m";
    elQTotal.innerText = QTOTAL.toFixed(3)+" m";
    elZLQreq.innerText = ZLQreq.toFixed(2)+" m";

    elZLQres.innerText = (MarginOfSafety>=0?"+":"")+MarginOfSafety.toFixed(2)+" m";
    if (MarginOfSafety >= 1.0){ elZLQres.className="kpi-value ok";   elStatus.className="kpi-status ok";   elStatus.innerText="SEGURO (Margem ‚â• 1,0 m)"; }
    else if (MarginOfSafety >= 0){ elZLQres.className="kpi-value warn"; elStatus.className="kpi-status warn"; elStatus.innerText="INSUFICIENTE (Margem 0‚Äì1,0 m)"; }
    else { elZLQres.className="kpi-value bad";  elStatus.className="kpi-status bad";  elStatus.innerText="COLIS√ÉO (Margem negativa)"; }

    const showAdv = (currentMode==='advanced');
    document.getElementById('cg-worker').style.display = showAdv?'block':'none';
    document.getElementById('cg-elasticity').style.display = showAdv?'block':'none';
    document.querySelectorAll('.row-elasticity').forEach(r=> r.style.display = showAdv?'flex':'none');

    inElasticity.disabled = !showAdv;
  }

  /* Boot */
  setTimeout(()=>{ 
    resize(); 
    setMode('basic'); // inicia em B√°sico
    updateSettings(); 
    drawScene(); // for√ßa primeira renderiza√ß√£o
  },100);
</script>
</body>
</html>
