<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Simulador NR-35 Pro ‚Äî ZLQ Analysis</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
  :root{
    --bg-app:#f4f7f6; --bg-panel:#ffffff;
    --c-safe:#27ae60; --c-warn:#f39c12; --c-danger:#c0392b;
    --c-text:#2c3e50; --c-primary:#2980b9;
  }
  *{box-sizing:border-box}
  body{font-family:'Inter',sans-serif;background:var(--bg-app);margin:0;padding:15px;height:100vh;overflow:hidden;display:flex;gap:15px;color:var(--c-text)}
  
  /* Sidebar */
  .sidebar{
    width:380px; flex-shrink:0; background:var(--bg-panel); padding:20px;
    border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.08);
    display:flex; flex-direction:column; gap:12px; overflow-y:auto; z-index:20;
  }
  h2{margin:0; font-size:1.1rem; display:flex; align-items:center; gap:8px;}
  .badge{font-size:0.7rem; background:#eee; padding:2px 6px; border-radius:4px; text-transform:uppercase; color:#7f8c8d;}
  
  /* Inputs */
  .control-section{border-bottom:1px solid #f0f0f0; padding-bottom:12px; margin-bottom:4px;}
  .lbl-row{display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;}
  label{font-size:0.8rem; font-weight:700; color:#34495e;}
  .val-tag{font-size:0.85rem; font-weight:800; color:var(--c-primary); background:#eaf2f8; padding:2px 6px; border-radius:4px;}
  input[type="range"]{width:100%; cursor:pointer; accent-color:var(--c-primary);}
  .helper{font-size:0.7rem; color:#95a5a6; margin-top:2px;}
  
  /* KPIs */
  .kpi-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px;}
  .kpi-card{background:#f8f9fa; padding:10px; border-radius:8px; border-left:3px solid #bdc3c7;}
  .kpi-card.full{grid-column:span 2;}
  .kpi-head{font-size:0.65rem; text-transform:uppercase; color:#7f8c8d; font-weight:700;}
  .kpi-main{font-size:1.1rem; font-weight:900; margin:4px 0;}
  .kpi-sub{font-size:0.75rem; font-weight:600;}
  
  .status-safe{border-color:var(--c-safe); color:var(--c-safe);}
  .status-warn{border-color:var(--c-warn); color:var(--c-warn);}
  .status-danger{border-color:var(--c-danger); color:var(--c-danger);}

  /* Breakdown Table */
  .breakdown{font-size:0.75rem; display:flex; flex-direction:column; gap:3px;}
  .bk-row{display:flex; justify-content:space-between; border-bottom:1px dashed #eee; padding-bottom:2px;}
  .bk-total{border-top:2px solid #ddd; margin-top:4px; padding-top:4px; font-weight:800; font-size:0.9rem;}

  /* Buttons */
  .actions{display:flex; gap:10px; margin-top:auto;}
  .btn{flex:1; padding:12px; border:none; border-radius:8px; font-weight:800; cursor:pointer; transition:all 0.2s;}
  .btn-run{background:var(--c-danger); color:#fff; box-shadow:0 4px 10px rgba(231,76,60,0.3);}
  .btn-run:hover{transform:translateY(-2px); box-shadow:0 6px 15px rgba(231,76,60,0.4);}
  .btn-rst{background:#ecf0f1; color:#2c3e50;}
  .btn-rst:hover{background:#dfe6e9;}

  /* Canvas Stage */
  .stage{
    flex:1; position:relative; background:linear-gradient(to bottom, #dbebf0 0%, #ecf5f7 100%);
    border-radius:12px; border:4px solid #fff; box-shadow:0 8px 24px rgba(0,0,0,0.05); overflow:hidden;
  }
  canvas{display:block; width:100%; height:100%;}
  
  #overlay-msg{
    position:absolute; top:20px; left:50%; transform:translateX(-50%) translateY(-20px);
    background:rgba(255,255,255,0.95); padding:10px 20px; border-radius:30px;
    font-weight:900; font-size:1rem; box-shadow:0 10px 25px rgba(0,0,0,0.2);
    opacity:0; transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events:none;
    display:flex; align-items:center; gap:10px; border:2px solid transparent;
  }
  #overlay-msg.show{opacity:1; transform:translateX(-50%) translateY(0);}
  .st-ok{color:var(--c-safe); border-color:var(--c-safe)!important;}
  .st-bad{color:var(--c-danger); border-color:var(--c-danger)!important;}

</style>
</head>
<body>

<div class="sidebar">
  <h2>ü¶∫ NR-35 Calc <span class="badge">PRO</span></h2>
  
  <div class="control-section">
    <div class="lbl-row"><label>1. Altura de Trabalho (H)</label><span id="disp-h" class="val-tag">6.0m</span></div>
    <input type="range" id="in-h" min="3.0" max="15.0" step="0.5" value="6.0">
    <div class="helper">Dist√¢ncia da plataforma ao solo</div>
  </div>

  <div class="control-section">
    <div class="lbl-row"><label>2. Comprimento Talabarte (L)</label><span id="disp-l" class="val-tag">1.4m</span></div>
    <input type="range" id="in-l" min="0.8" max="2.0" step="0.1" value="1.4">
  </div>

  <div class="control-section">
    <div class="lbl-row"><label>3. Absorvedor (DEC)</label><span id="disp-dec" class="val-tag">1.1m</span></div>
    <input type="range" id="in-dec" min="0.0" max="1.5" step="0.1" value="1.1">
    <div class="helper">Extens√£o m√°xima do ABS ap√≥s impacto</div>
  </div>

  <div class="control-section">
    <div class="lbl-row"><label>4. Fator de Queda (Ancoragem)</label><span id="disp-fq" class="val-tag">FQ 0</span></div>
    <input type="range" id="in-fq" min="0" max="2" step="1" value="0">
    <div class="helper" id="fq-desc">Acima da cabe√ßa (Melhor cen√°rio)</div>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card full">
      <div class="kpi-head">An√°lise de ZLQ</div>
      <div class="breakdown">
        <div class="bk-row"><span>Corda/Talabarte (L)</span> <b id="k-l">--</b></div>
        <div class="bk-row"><span>Queda Livre Extra (DQ)</span> <b id="k-dq">--</b></div>
        <div class="bk-row"><span>Absorvedor (DEC)</span> <b id="k-dec">--</b></div>
        <div class="bk-row"><span>Elasticidade (EL 15%)</span> <b id="k-el">--</b></div>
        <div class="bk-row"><span>Corpo (BODY)</span> <b>1.50 m</b></div>
        <div class="bk-row"><span>Seguran√ßa (S)</span> <b>1.00 m</b></div>
        <div class="bk-row bk-total"><span>ZLQ REQUERIDA</span> <span id="k-req" style="color:var(--c-primary)">--</span></div>
      </div>
    </div>

    <div class="kpi-card full" id="card-result">
      <div class="kpi-head">Margem Livre (H - ZLQ)</div>
      <div class="kpi-main" id="k-margin">--</div>
      <div class="kpi-sub" id="k-status">--</div>
    </div>
  </div>

  <div class="actions">
    <button class="btn btn-rst" id="btn-reset">Resetar</button>
    <button class="btn btn-run" id="btn-sim">SIMULAR QUEDA</button>
  </div>
</div>

<div class="stage" id="stage-cont">
  <canvas id="sim"></canvas>
  <div id="overlay-msg"></div>
</div>

<script>
/**
 * L√ìGICA T√âCNICA
 * -------------------
 * F√≥rmulas baseadas na NBR 16489.
 * ZLQ = DQ + DEC + EL + BODY + S
 * DQ varia conforme o Fator de Queda (FQ).
 */

const CFG = {
  BODY: 1.5, // D-ring to feet + harness stretch
  SAFE: 1.0, // Safety margin
  EL_PCT: 0.15 // 15% system elasticity
};

const UI = {
  inH: document.getElementById('in-h'),
  inL: document.getElementById('in-l'),
  inDec: document.getElementById('in-dec'),
  inFq: document.getElementById('in-fq'),
  
  dispH: document.getElementById('disp-h'),
  dispL: document.getElementById('disp-l'),
  dispDec: document.getElementById('disp-dec'),
  dispFq: document.getElementById('disp-fq'),
  descFq: document.getElementById('fq-desc'),
  
  kL: document.getElementById('k-l'),
  kDq: document.getElementById('k-dq'),
  kDec: document.getElementById('k-dec'),
  kEl: document.getElementById('k-el'),
  kReq: document.getElementById('k-req'),
  kMargin: document.getElementById('k-margin'),
  kStatus: document.getElementById('k-status'),
  cardRes: document.getElementById('card-result'),
  
  canvas: document.getElementById('sim'),
  overlay: document.getElementById('overlay-msg')
};

let state = {
  H: 6.0, L: 1.4, DEC: 1.1, FQ: 0,
  DQ:0, EL:0, ZLQ:0, Margin:0,
  isFallen: false, animY: 0
};

// Canvas World
let ctx = UI.canvas.getContext('2d');
let W, H_px, groundY, pxPerM;

function init(){
  addEvents();
  resize();
  updateData();
  draw();
}

function addEvents(){
  [UI.inH, UI.inL, UI.inDec, UI.inFq].forEach(el => el.addEventListener('input', () => {
    resetSim();
  }));
  document.getElementById('btn-sim').addEventListener('click', runSim);
  document.getElementById('btn-rst').addEventListener('click', resetSim);
  window.addEventListener('resize', resize);
}

function updateData(){
  // 1. Get Values
  state.H = parseFloat(UI.inH.value);
  state.L = parseFloat(UI.inL.value);
  state.DEC = parseFloat(UI.inDec.value);
  state.FQ = parseInt(UI.inFq.value);

  // 2. Calculate Physics
  // DQ Calculation
  if(state.FQ === 0) state.DQ = 0; // Overhead taut
  else if(state.FQ === 1) state.DQ = state.L; // Beam level
  else state.DQ = state.L + 1.5; // Foot level (severe)

  state.EL = (state.L + state.DEC) * CFG.EL_PCT;
  
  state.ZLQ = state.DQ + state.DEC + state.EL + CFG.BODY + CFG.SAFE;
  state.Margin = state.H - state.ZLQ;

  syncScale();

  // 3. Update UI Text
  UI.dispH.innerText = state.H.toFixed(1)+'m';
  UI.dispL.innerText = state.L.toFixed(2)+'m';
  UI.dispDec.innerText = state.DEC.toFixed(2)+'m';
  
  const fqLabels = ["FQ‚âà0 (Acima)", "FQ=1 (Cintura)", "FQ=2 (P√©s)"];
  const fqDescs = ["Queda m√≠nima (Reten√ß√£o)", "Queda livre = Comp. Talabarte", "Queda severa (L + 1.5m)"];
  UI.dispFq.innerText = fqLabels[state.FQ];
  UI.descFq.innerText = fqDescs[state.FQ];

  UI.kL.innerText = state.L.toFixed(2)+'m';
  UI.kDq.innerText = state.DQ.toFixed(2)+'m';
  UI.kDec.innerText = state.DEC.toFixed(2)+'m';
  UI.kEl.innerText = state.EL.toFixed(2)+'m';
  UI.kReq.innerText = state.ZLQ.toFixed(2)+'m';
  
  const mVal = state.Margin.toFixed(2);
  UI.kMargin.innerText = (state.Margin > 0 ? "+":"") + mVal + " m";
  
  UI.cardRes.className = "kpi-card full";
  if(state.Margin >= 0) {
    UI.cardRes.classList.add('status-safe');
    UI.kStatus.innerText = "‚úì ZONA SEGURA";
  } else {
    UI.cardRes.classList.add('status-danger');
    UI.kStatus.innerText = "‚úó COLIS√ÉO COM SOLO";
  }

  if(!state.isFallen) {
    state.animY = getCoords().dRingY;
    draw();
  }
}

/* ---- CANVAS & VISUALS ---- */

function syncScale(){
  if(typeof groundY !== 'number') return;
  const maxViewM = Math.max(state.H + 2, 8);
  pxPerM = (groundY - 50) / maxViewM;
}

function resize(){
  const cont = document.getElementById('stage-cont');
  W = UI.canvas.width = cont.offsetWidth;
  H_px = UI.canvas.height = cont.offsetHeight;
  groundY = H_px - 40;
  syncScale();
  draw();
}

function getCoords(){
  // O "Zero" √© o ch√£o visual
  // WorkPlatformY √© calculado para cima a partir do ch√£o
  const platY = groundY - (state.H * pxPerM);
  
  // Boneco
  const workerH_px = 1.75 * pxPerM; // 1.75m visual height
  const feetY = platY;
  const dRingY = feetY - (CFG.BODY * pxPerM); // 1.5m acima dos p√©s
  
  // Ancoragem
  let anchorY = dRingY; 
  if(state.FQ === 0) anchorY = dRingY - (1.5 * pxPerM); // ~Overhead
  else if(state.FQ === 2) anchorY = feetY; // Feet level

  return { platY, feetY, dRingY, anchorY, workerH_px };
}

function draw(){
  ctx.clearRect(0,0,W,H_px);
  
  const c = getCoords();
  const workerX = W/2;
  const anchorX = workerX - 40;

  // 1. Grid & Ruler
  drawRuler();

  // 2. Ground & Platform
  ctx.fillStyle = "#ecf0f1"; ctx.fillRect(0, groundY, W, H_px-groundY); // Subsolo
  ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(W, groundY); 
  ctx.strokeStyle = "#7f8c8d"; ctx.lineWidth=3; ctx.stroke();
  ctx.fillStyle="#7f8c8d"; ctx.font="10px Inter"; ctx.fillText("SOLO (N√çVEL 0)", 10, groundY+15);

  // Plataforma
  ctx.beginPath(); ctx.moveTo(0, c.platY); ctx.lineTo(W, c.platY);
  ctx.strokeStyle = "#bdc3c7"; ctx.lineWidth=4; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
  ctx.fillText(`PLATAFORMA (H=${state.H}m)`, 10, c.platY-5);

  // 3. Current Worker Position (Y)
  // Se caiu, usar state.animY. Se n√£o, usar posi√ß√£o inicial (c.dRingY)
  let currentDRingY = state.isFallen ? state.animY : c.dRingY;
  let currentFeetY = currentDRingY + (CFG.BODY * pxPerM);

  // Desenhar Boneco
  drawWorker(workerX, currentFeetY, c.workerH_px);

  // 4. Corda / Sistema
  ctx.beginPath();
  ctx.moveTo(anchorX, c.anchorY);
  ctx.lineTo(workerX, currentDRingY); // Conecta no D-Ring atual
  
  if(state.isFallen){
    // Corda esticada (Visualiza√ß√£o p√≥s-queda)
    // Cores diferentes para L, DEC, EL
    ctx.strokeStyle = "#e67e22"; ctx.lineWidth=3; ctx.stroke(); 
    // Em uma vers√£o mais complexa, segmentar√≠amos a linha aqui
  } else {
    // Corda "frouxa" ou reta dependendo da posi√ß√£o
    // Curva quadr√°tica para simular folga se FQ for alto e ainda n√£o caiu
    if(state.FQ > 0) {
      ctx.quadraticCurveTo(anchorX, currentDRingY, workerX, currentDRingY);
    }
    ctx.strokeStyle = "#f39c12"; ctx.lineWidth=3; ctx.stroke();
  }

  // Ponto de Ancoragem
  ctx.beginPath(); ctx.arc(anchorX, c.anchorY, 6, 0, Math.PI*2);
  ctx.fillStyle = "#2980b9"; ctx.fill(); ctx.strokeStyle="#fff"; ctx.stroke();

  // 5. Cotas (S√≥ desenha se caiu)
  if(state.isFallen) drawDimensions(c.dRingY, workerX + 60);
}

function drawWorker(x, feetY, hPx){
  ctx.save();
  ctx.translate(x, feetY - hPx); // Topo da cabe√ßa
  // Simplificado
  ctx.fillStyle = "#34495e";
  ctx.fillRect(-10, hPx*0.2, 20, hPx*0.4); // Torso
  ctx.fillStyle = "#2c3e50";
  ctx.fillRect(-10, hPx*0.6, 10, hPx*0.4); // Perna E
  ctx.fillRect(0, hPx*0.6, 10, hPx*0.4);   // Perna D
  ctx.fillStyle = "#e67e22"; 
  ctx.beginPath(); ctx.arc(0, hPx*0.15, 12, 0, Math.PI*2); ctx.fill(); // Cabe√ßa
  // D-Ring (aprox 1.5m dos p√©s, ou seja, hPx - 1.5*px)
  const dRingVis = hPx - (CFG.BODY * pxPerM);
  ctx.fillStyle="red"; ctx.beginPath(); ctx.arc(0, dRingVis, 4, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

function drawDimensions(originY, xBase){
  // Desenha as barras laterais que explicam a ZLQ
  // Ordem: DQ -> DEC -> EL -> BODY -> S
  let yCursor = originY; // Come√ßa onde o D-Ring estava
  
  const drawDim = (label, valM, color) => {
    if(valM <= 0) return;
    const h = valM * pxPerM;
    ctx.fillStyle = color;
    ctx.fillRect(xBase, yCursor, 6, h);
    
    // Linha conectora
    ctx.beginPath(); ctx.moveTo(xBase, yCursor+h); ctx.lineTo(xBase+15, yCursor+h);
    ctx.strokeStyle=color; ctx.lineWidth=1; ctx.stroke();
    
    ctx.font = "bold 11px Inter"; ctx.fillStyle=color;
    ctx.fillText(`${label} ${valM.toFixed(2)}m`, xBase+20, yCursor + h/2 + 4);
    
    yCursor += h;
  };

  drawDim("DQ (Queda Livre)", state.DQ, "#e74c3c");
  drawDim("DEC (Absorvedor)", state.DEC, "#f39c12");
  drawDim("EL (Elasticidade)", state.EL, "#9b59b6");
  drawDim("BODY (Anel-P√©s)", CFG.BODY, "#34495e");
  drawDim("S (Margem)", CFG.SAFE, "#27ae60");

  // Linha Limite ZLQ
  ctx.beginPath(); ctx.moveTo(xBase-40, yCursor); ctx.lineTo(xBase+120, yCursor);
  ctx.strokeStyle="#c0392b"; ctx.lineWidth=2; ctx.setLineDash([4,2]); ctx.stroke(); ctx.setLineDash([]);
  ctx.fillStyle="#c0392b"; ctx.fillText("LIMITE ZLQ REQUERIDO", xBase+20, yCursor+12);
}

function drawRuler(){
  const meters = Math.ceil(H_px / pxPerM);
  ctx.fillStyle = "rgba(0,0,0,0.1)";
  ctx.font = "10px Inter";
  for(let i=0; i<meters; i++){
    let y = groundY - (i * pxPerM);
    if(y < 0) break;
    ctx.fillRect(0, y, 10, 1);
    if(i%2===0) ctx.fillText(i+"m", 12, y+3);
  }
}

/* ---- SIMULATION LOGIC ---- */

function runSim(){
  if(state.isFallen) return;
  
  // Calcular onde o D-Ring vai parar (sem contar o S, pois o boneco para fisicamente antes do S)
  // Posi√ß√£o Final F√≠sica = Posi√ß√£o Inicial - (DQ + DEC + EL)
  // MAS visualmente √© mais f√°cil calcular baseado no ch√£o se houve colis√£o.
  
  const c = getCoords();
  // Dist√¢ncia total de queda do D-Ring
  const totalDropM = state.DQ + state.DEC + state.EL; 
  const targetY = c.dRingY + (totalDropM * pxPerM);
  
  // Limite f√≠sico do ch√£o (D-ring n√£o pode passar de groundY - 1.5m visualmente se colidir, 
  // mas vamos deixar passar para mostrar o erro)
  
  state.isFallen = true;
  state.animY = c.dRingY;
  
  // Anima√ß√£o
  let start = null;
  const duration = 1000;
  
  function step(timestamp){
    if(!start) start = timestamp;
    const progress = Math.min((timestamp - start)/duration, 1);
    // Easing: easeOutBounce customizado simples
    const ease = progress * (2 - progress); 
    
    state.animY = c.dRingY + ((targetY - c.dRingY) * ease);
    
    draw();
    
    if(progress < 1) {
      window.requestAnimationFrame(step);
    } else {
      finishSim();
    }
  }
  window.requestAnimationFrame(step);
}

function finishSim(){
  const isSafe = state.Margin >= 0;
  UI.overlay.className = isSafe ? "st-ok show" : "st-bad show";
  
  let msg = "";
  let icon = "";
  if(state.Margin >= 0){ msg="QUEDA RETIDA COM SEGURAN√áA"; icon="üõ°Ô∏è"; }
  else { msg="COLIS√ÉO FATAL COM O SOLO"; icon="üíÄ"; }
  
  UI.overlay.innerHTML = `<span>${icon}</span> ${msg}`;
  draw(); // Redesenha para mostrar cotas
}

function resetSim(){
  state.isFallen = false;
  UI.overlay.classList.remove('show');
  updateData(); // Redesenha estado inicial
}

// Boot
init();

</script>
</body>
</html>
