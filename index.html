<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador NR-35 (V7: Altura Configur√°vel)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');

        :root {
            --cor-fundo: #eef2f6;
            --cor-painel: #fff;
            --cor-seguro: #2ecc71;
            --cor-atencao: #f1c40f;
            --cor-critico: #e74c3c;
            --cor-corda: #f39c12;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--cor-fundo);
            margin: 0; padding: 20px;
            height: 100vh; overflow: hidden;
            display: flex; gap: 20px;
        }

        /* --- Painel Lateral --- */
        .sidebar {
            width: 320px;
            background: var(--cor-painel);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 15px;
            z-index: 10;
            overflow-y: auto;
        }

        h2 { margin: 0 0 5px 0; font-size: 1.2rem; color: #2c3e50; }
        .subtitle { font-size: 0.8rem; color: #7f8c8d; margin-bottom: 10px; }
        
        .control-group {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }

        label { font-size: 0.85rem; font-weight: 600; color: #34495e; display: block; margin-bottom: 5px; }
        
        input[type="range"] { width: 100%; margin: 5px 0; cursor: pointer; }
        .val-display { font-size: 0.9rem; font-weight: bold; color: #2980b9; float: right; }

        .btn-action {
            padding: 15px; border: none; border-radius: 8px;
            font-weight: 800; cursor: pointer; transition: transform 0.1s, background 0.2s;
            color: white; font-size: 1rem; text-transform: uppercase;
            width: 100%; margin-top: 5px;
        }
        .btn-simular { background: linear-gradient(135deg, #3498db, #2980b9); box-shadow: 0 4px 0 #1c5a85; }
        .btn-simular:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #1c5a85; }
        .btn-simular:active { transform: translateY(2px); box-shadow: 0 0 0 #1c5a85; }
        
        .btn-reset { background: #95a5a6; box-shadow: 0 4px 0 #7f8c8d; margin-top: 10px;}
        .btn-reset:hover { background: #7f8c8d; }
        .btn-reset:active { transform: translateY(2px); box-shadow: 0 0 0 #7f8c8d; }

        /* KPIs */
        .kpi-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .kpi-box {
            background: #f8f9fa; padding: 10px; border-radius: 6px;
            border-left: 4px solid #ddd;
        }
        .kpi-title { font-size: 0.65rem; text-transform: uppercase; color: #666; font-weight: 700; }
        .kpi-value { font-size: 1.1rem; font-weight: 900; color: #333; }
        .kpi-status { font-size: 0.7rem; font-weight: bold; margin-top: 2px; }

        /* --- Palco (Canvas) --- */
        .stage-container {
            flex: 1;
            background: linear-gradient(to bottom, #87CEEB 0%, #e0f7fa 100%);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid #fff;
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }

        /* Elementos Visuais Sobrepostos */
        .ruler-label {
            position: absolute; right: 10px; color: rgba(0,0,0,0.4); 
            font-size: 0.8rem; font-weight: bold; pointer-events: none; border-bottom: 1px solid rgba(0,0,0,0.1);
            width: 50px; text-align: right;
        }

        #alert-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(231, 76, 60, 0.95); color: white;
            padding: 30px 50px; border-radius: 12px; font-size: 2.5rem; font-weight: 900;
            text-align: center; z-index: 100; opacity: 0; pointer-events: none;
            transition: opacity 0.2s, transform 0.2s; box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            border: 4px solid white;
        }

        .success-overlay {
            background: rgba(46, 204, 113, 0.95) !important;
        }

    </style>
</head>
<body>

    <div class="sidebar">
        <div>
            <h2>‚öôÔ∏è Simulador NR-35</h2>
            <div class="subtitle">F√≠sica e Colis√£o em Tempo Real</div>
        </div>
        
        <div class="control-group">
            <label>1. Altura de Trabalho (H)</label>
            <span id="val-height" class="val-display">6.0m</span>
            <input type="range" id="input-height" min="2.0" max="10.0" step="0.5" value="6.0">
            <small style="color:#888; font-size:0.7em">Altura dos p√©s em rela√ß√£o ao solo</small>
        </div>

        <div class="control-group">
            <label>2. Comp. Talabarte (L)</label>
            <span id="val-l" class="val-display">1.5m</span>
            <input type="range" id="input-l" min="1.0" max="2.0" step="0.1" value="1.5">
        </div>

        <div class="control-group">
            <label>3. Posi√ß√£o da Ancoragem</label>
            <span id="val-anchor" class="val-display">Overhead</span>
            <input type="range" id="input-anchor" min="0" max="2" step="1" value="0">
            <small style="color:#888; font-size:0.7em; display:block; margin-top:5px">
                0: Acima (FQ 0) | 1: Cinto (FQ 1) | 2: P√©s (FQ 2)
            </small>
        </div>

        <div class="kpi-container">
            <div class="kpi-box">
                <div class="kpi-title">ZLQ Necess√°ria</div>
                <div class="kpi-value" id="kpi-zlq">-- m</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-title">Margem de Sobra</div>
                <div class="kpi-value" id="kpi-margin">-- m</div>
                <div class="kpi-status" id="kpi-status">--</div>
            </div>
        </div>

        <button class="btn-action btn-simular" onclick="startSimulation()">‚ö†Ô∏è SIMULAR QUEDA</button>
        <button class="btn-action btn-reset" onclick="resetSimulation()">üîÑ RESETAR</button>
    </div>

    <div class="stage-container" id="stage">
        <div id="alert-overlay">COLIS√ÉO COM O SOLO!</div>
        <canvas id="simCanvas"></canvas>
    </div>

<script>
    // --- Configura√ß√µes F√≠sicas ---
    const GRAVITY = 0.6;       // Gravidade
    const DAMPING = 0.96;      // Resist√™ncia do ar
    const PX_PER_METER = 50;   // Escala visual: 50px = 1 metro
    const WORKER_H_PX = 90;    // Altura do boneco (aprox 1.8m)
    const DECEL = 1.2;     // m - distens√£o do absorvedor (conservador)
    const DR_SHIFT = 0.3;  // m - deslocamento do D-ring/arn√™s
    const BODY = 1.5;      // m - altura abaixo do D-ring (por√ß√£o do corpo)
    const SAFETY = 1.0;    // m - folga de seguran√ßa

    // --- Estado da Simula√ß√£o ---
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    
    let running = false;
    let crashed = false;
    let finished = false;

    // Objetos
    let world = { groundY: 0 };
    let anchor = { x: 0, y: 0, fq: 0 }; 
    let worker = { x: 0, y: 0, vx: 0, vy: 0, startY: 0 };
    let rope = { lengthM: 1.5 };
    let config = { workHeightM: 6.0 };

    // Inputs DOM
    const inHeight = document.getElementById('input-height');
    const inLength = document.getElementById('input-l');
    const inAnchor = document.getElementById('input-anchor');
    
    // Labels
    const lblHeight = document.getElementById('val-height');
    const lblLength = document.getElementById('val-l');
    const lblAnchor = document.getElementById('val-anchor');

    // Inicializa√ß√£o
    function resize() {
        canvas.width = document.getElementById('stage').offsetWidth;
        canvas.height = document.getElementById('stage').offsetHeight;
        world.groundY = canvas.height - 40; // Ch√£o fica 40px acima do fundo do canvas
        resetSimulation();
    }
    window.addEventListener('resize', resize);

    function updateSettings() {
        // Ler Inputs
        config.workHeightM = parseFloat(inHeight.value);
        rope.lengthM = parseFloat(inLength.value);
        anchor.fq = parseInt(inAnchor.value);

        // Atualizar Textos
        lblHeight.innerText = config.workHeightM.toFixed(1) + "m";
        lblLength.innerText = rope.lengthM.toFixed(1) + "m";
        
        const anchorLabels = ["Acima (FQ 0)", "Cinto (FQ 1)", "P√©s (FQ 2)"];
        lblAnchor.innerText = anchorLabels[anchor.fq];

        // Posicionar Trabalhador (Apenas se n√£o estiver rodando)
        if (!running) {
            // A posi√ß√£o Y √© calculada de baixo para cima
            // GroundY - (Metros * Pixels) = Posi√ß√£o dos P√©s
            const feetY = world.groundY - (config.workHeightM * PX_PER_METER);
            
            // O Worker.y √© o topo da cabe√ßa (top-left do rect), ent√£o subtra√≠mos a altura do boneco
            worker.y = feetY - WORKER_H_PX;
            worker.x = canvas.width / 2;
            worker.startY = worker.y;
            
            // Posicionar Ancoragem RELATIVA ao trabalhador
            // D-Ring (conex√£o) fica nas costas, aprox 30px do topo
            const dRingY = worker.y + 30;
            
            if (anchor.fq === 0) {
                // Acima da cabe√ßa (ex: 1.5m acima do D-Ring)
                anchor.y = dRingY - (1.5 * PX_PER_METER);
            } else if (anchor.fq === 1) {
                // N√≠vel do cinto
                anchor.y = dRingY;
            } else {
                // N√≠vel dos p√©s (Abaixo do cinto)
                // P√©s est√£o em feetY.
                anchor.y = feetY;
            }
            anchor.x = worker.x - 20; // Levemente √† esquerda
        }
        
        calcKPIs();
        if(!running) drawScene();
    }

    [inHeight, inLength, inAnchor].forEach(el => el.addEventListener('input', updateSettings));

    // --- Loop de F√≠sica ---
    function loop() {
        if (!running) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. Gravidade
        if (!crashed && !finished) {
            worker.vy += GRAVITY;
            worker.vx *= DAMPING;
            worker.vy *= DAMPING;
            worker.x += worker.vx;
            worker.y += worker.vy;
        }

        // 2. Colis√£o com Ch√£o (SOLO)
        // P√©s do trabalhador = worker.y + WORKER_H_PX
        if ((worker.y + WORKER_H_PX) >= world.groundY) {
            if (!crashed && !finished) {
                // IMPACTO!
                crashed = true;
                worker.y = world.groundY - WORKER_H_PX;
                worker.vy = 0;
                showResult(false); // False = Morte/Acidente
            }
        }

        // 3. Mec√¢nica da Corda
        const dRingX = worker.x;
        const dRingY = worker.y + 30;

        const dx = dRingX - anchor.x;
        const dy = dRingY - anchor.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        
        // Comprimento m√°ximo (Corda + Absorvedor abrindo)
        // Adicionamos 1.2m de absorvedor "virtual" na f√≠sica
        const maxDistPx = (rope.lengthM + 1.1) * PX_PER_METER;

        if (dist > maxDistPx && !crashed) {
            // Corda esticada -> For√ßa el√°stica
            const angle = Math.atan2(dy, dx);
            const pullX = Math.cos(angle) * maxDistPx + anchor.x;
            const pullY = Math.sin(angle) * maxDistPx + anchor.y;

            // Mola
            const k = 0.08; // Rigidez
            worker.vx -= (dRingX - pullX) * k;
            worker.vy -= (dRingY - pullY) * k;
            
            // Se a velocidade for muito baixa, consideramos "Retido"
            if (Math.abs(worker.vy) < 0.1 && Math.abs(worker.vx) < 0.1 && !finished) {
                finished = true;
                showResult(true); // True = Salvo
            }
        }

        drawScene();
        requestAnimationFrame(loop);
    }

    // --- Renderiza√ß√£o ---
    function drawScene() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 1. Desenhar Cen√°rio de Fundo (R√©guas)
        drawRulers();

        // 2. Desenhar Plataforma de Trabalho
        // Linha cinza onde come√ßou
        const platformY = worker.startY + WORKER_H_PX;
        ctx.beginPath();
        ctx.moveTo(0, platformY);
        ctx.lineTo(canvas.width, platformY);
        ctx.strokeStyle = "#bdc3c7";
        ctx.lineWidth = 4;
        ctx.setLineDash([10, 10]);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // Label Plataforma
        ctx.fillStyle = "#7f8c8d";
        ctx.font = "bold 12px Inter";
        ctx.fillText("PLATAFORMA DE TRABALHO", 10, platformY - 5);

        // 3. Desenhar Ch√£o
        ctx.fillStyle = "#5d4037";
        ctx.fillRect(0, world.groundY, canvas.width, canvas.height - world.groundY);
        ctx.fillStyle = "#8d6e63"; // Borda
        ctx.fillRect(0, world.groundY, canvas.width, 5);
        ctx.fillStyle = "rgba(255,255,255,0.3)";
        ctx.fillText("SOLO (N√çVEL 0)", canvas.width/2 - 40, world.groundY + 25);

        // 4. Corda
        const dRingX = worker.x;
        const dRingY = worker.y + 30;
        
        ctx.beginPath();
        ctx.moveTo(anchor.x, anchor.y);
        
        // Curva da corda (Simula√ß√£o visual de frouxid√£o)
        const dx = dRingX - anchor.x;
        const dy = dRingY - anchor.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const ropePx = rope.lengthM * PX_PER_METER;
        
        if (dist < ropePx && !crashed && !finished) {
            // Curva (B√©zier)
            const slack = (ropePx - dist) * 0.6;
            ctx.quadraticCurveTo(anchor.x + dx/2, anchor.y + dy + slack, dRingX, dRingY);
            ctx.strokeStyle = "#f39c12";
            ctx.lineWidth = 3;
        } else {
            // Reta (Tensa)
            ctx.lineTo(dRingX, dRingY);
            ctx.strokeStyle = (dist > ropePx) ? "#c0392b" : "#f39c12"; // Vermelho se esticando absorvedor
            ctx.lineWidth = (dist > ropePx) ? 2 : 3;
        }
        ctx.stroke();

        // 5. Ancoragem
        ctx.beginPath();
        ctx.arc(anchor.x, anchor.y, 6, 0, Math.PI*2);
        ctx.fillStyle = "#2980b9";
        ctx.fill();

        // 6. Trabalhador
        ctx.save();
        ctx.translate(worker.x, worker.y);
        
        if (crashed) {
            ctx.translate(0, WORKER_H_PX); 
            ctx.rotate(-Math.PI/2); 
            ctx.translate(0, -WORKER_H_PX);
        } else if (running) {
            // Balan√ßo leve
            ctx.rotate(worker.vx * 0.05);
        }

        // Corpo Stickman "Gordinho" (Melhor visibilidade)
        // Cabe√ßa
        ctx.fillStyle = "#f1c40f"; // Pele
        ctx.beginPath(); ctx.arc(0, 10, 10, 0, Math.PI*2); ctx.fill();
        // Capacete
        ctx.fillStyle = "#e74c3c"; 
        ctx.beginPath(); ctx.arc(0, 6, 11, Math.PI, 0); ctx.fill();
        // Torso
        ctx.fillStyle = "#3498db";
        ctx.fillRect(-12, 20, 24, 35);
        // Cinto
        ctx.fillStyle = "#2c3e50";
        ctx.fillRect(-13, 28, 26, 6); // Faixa peito
        // Pernas
        ctx.fillStyle = "#34495e";
        ctx.fillRect(-10, 55, 8, 35);
        ctx.fillRect(2, 55, 8, 35);

        ctx.restore();
    }

    function drawRulers() {
        // Desenha linhas horizontais a cada metro
        const meters = Math.ceil(canvas.height / PX_PER_METER);
        ctx.strokeStyle = "rgba(0,0,0,0.05)";
        ctx.lineWidth = 1;
        ctx.fillStyle = "rgba(0,0,0,0.3)";
        ctx.font = "10px Inter";

        for(let i=0; i<=meters; i++) {
            const y = world.groundY - (i * PX_PER_METER);
            if (y < 0) break;
            
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
            
            if (i > 0) ctx.fillText(i + "m", canvas.width - 30, y + 3);
        }
    }

    // --- L√≥gica de Controle ---
    function startSimulation() {
        if (running) return;
        
        // Atualiza posi√ß√£o uma √∫ltima vez para garantir
        updateSettings();
        
        running = true;
        crashed = false;
        finished = false;
        document.getElementById('alert-overlay').style.opacity = 0;
        document.getElementById('alert-overlay').className = '';
        
        loop();
    }

    function resetSimulation() {
        running = false;
        crashed = false;
        finished = false;
        worker.vx = 0;
        worker.vy = 0;
        document.getElementById('alert-overlay').style.opacity = 0;
        updateSettings();
    }

    function showResult(safe) {
        const el = document.getElementById('alert-overlay');
        el.innerText = safe ? "RETIDO COM SUCESSO" : "COLIS√ÉO FATAL!";
        el.className = safe ? "success-overlay" : "";
        el.style.opacity = 1;
        el.style.transform = "translate(-50%, -50%) scale(1.1)";
        setTimeout(() => el.style.transform = "translate(-50%, -50%) scale(1)", 200);
    }

    function calcKPIs() {
        // C√°lculos T√©cnicos para o Painel
        const l = rope.lengthM;           // comprimento do talabarte (m)
  	const h = config.workHeightM;     // altura dos p√©s (m)
  	const fq = anchor.fq;             // 0=acima | 1=cinto | 2=p√©s

        // Dist√¢ncia de queda livre estimada por FQ
 	 // FQ0 ‚âà 0,6 m (folga/ativa√ß√£o); FQ1 ‚âà L; FQ2 ‚âà L + 1,5 m (D-ring‚Üíp√©s)
  	let quedaLivre;
  	if (fq === 0) quedaLivre = 0.6;
 	else if (fq === 1) quedaLivre = l;
  	else quedaLivre = l + 1.5;
        
        // ZLQ requerida = QuedaLivre + Desacelera√ß√£o + D-ring shift + Corpo abaixo do D-ring + Folga
  	const zlqReq = +(quedaLivre + DECEL + DR_SHIFT + BODY + SAFETY).toFixed(2);
  	const margem = +(h - zlqReq).toFixed(2);

 	// Atualiza√ß√£o do painel (sem alterar visual da simula√ß√£o)
  	document.getElementById('kpi-zlq').innerText = `${zlqReq.toFixed(2)} m`;

  	const elMargem = document.getElementById('kpi-margin');
  	const elStatus = document.getElementById('kpi-status');

 	 elMargem.innerText = (margem > 0 ? "+" : "") + margem.toFixed(2) + " m";

 	 if (margem >= 0.5) {
 	   elMargem.style.color = "#2ecc71"; // verde
 	   elStatus.innerText = "SEGURO";
  	   elStatus.style.color = "#2ecc71";
 	 } else if (margem >= 0) {
 	   elMargem.style.color = "#f1c40f"; // amarelo
 	   elStatus.innerText = "ATEN√á√ÉO (Margem Baixa)";
 	   elStatus.style.color = "#f39c12";
 	 } else {
  	  elMargem.style.color = "#e74c3c"; // vermelho
  	  elStatus.innerText = "CR√çTICO (Colis√£o)";
  	  elStatus.style.color = "#e74c3c";
  }

	 // Aviso t√©cnico n√£o intrusivo: FQ2 com L elevado (pr√°tica de fabricantes)
 	 if (fq === 2 && l > 1.8) {
   	  elStatus.innerText += " ‚Ä¢ Aviso: FQ2 com L>1,8 m pode ser vedado por fabricantes";
  	  // Mantemos a cor j√° definida acima para n√£o ‚Äúpiscar‚Äù a UI
  }
}

    // Boot
    setTimeout(() => {
        resize();
        updateSettings();
    }, 100);

</script>
</body>
</html>
