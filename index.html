<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Simulador NR-35 ‚Äî Conforme Norma T√©cnica (V14)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
  :root{
    --cor-fundo:#eef2f6; --cor-painel:#fff;
    --cor-seguro:#2ecc71; --cor-atencao:#f1c40f; --cor-critico:#e74c3c;
    --cor-corda:#f39c12; --cor-texto:#2c3e50;
  }
  *{box-sizing:border-box}
  body{font-family:'Inter',sans-serif;background:var(--cor-fundo);margin:0;padding:20px;height:100vh;overflow:hidden;display:flex;gap:20px;color:var(--cor-texto)}
  .sidebar{width:360px;background:var(--cor-painel);padding:18px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);display:flex;flex-direction:column;gap:14px;z-index:10;overflow-y:auto}
  h2{margin:0 0 6px;font-size:1.15rem;color:#2c3e50}
  .subtitle{font-size:.8rem;color:#7f8c8d;margin-bottom:6px}
  .alert-box{background:#fff3cd;border:2px solid #f39c12;border-radius:8px;padding:10px;margin-bottom:10px;font-size:.82rem;color:#856404}
  .control-group{border-bottom:1px solid #eee;padding-bottom:10px;margin-bottom:6px}
  label{font-size:.86rem;font-weight:700;color:#34495e;display:block;margin-bottom:6px}
  input[type="range"]{width:100%;margin:3px 0 6px;cursor:pointer}
  .val-display{font-size:.9rem;font-weight:900;color:#1f5fa6;float:right}
  .hint{color:#7f8c8d;font-size:.74rem;margin-top:4px}
  .btn{padding:14px;border:none;border-radius:10px;font-weight:900;cursor:pointer;transition:transform .1s,box-shadow .2s,color .2s;background:#2563eb;color:#fff;text-transform:uppercase}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(37,99,235,.25)}
  .btn-secondary{background:#95a5a6}
  .kpi-panel{display:grid;grid-template-columns:1fr;gap:10px}
  .kpi-box{background:#f8f9fa;padding:10px;border-radius:8px;border-left:4px solid #e5e7eb}
  .kpi-title{font-size:.68rem;text-transform:uppercase;color:#666;font-weight:800;margin-bottom:6px}
  .kpi-value{font-size:1.2rem;font-weight:900}
  .kpi-status{font-size:.8rem;font-weight:900;margin-top:4px}
  .kpi-list{margin-top:6px}
  .kpi-row{display:flex;justify-content:space-between;font-size:.86rem;padding:3px 0;border-bottom:1px dashed #e5e7eb}
  .kpi-row:last-child{border-bottom:none}
  .ok{color:var(--cor-seguro)} .warn{color:var(--cor-atencao)} .bad{color:var(--cor-critico)}
  .stage-container{flex:1;background:linear-gradient(to bottom,#87CEEB 0%,#e0f7fa 100%);border-radius:12px;position:relative;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.1);border:2px solid #fff}
  canvas{position:absolute;inset:0;width:100%;height:100%;z-index:2}
  #alert-overlay{
    position:absolute;
    padding:14px 18px;
    border-radius:12px;
    font-size:1.05rem;
    font-weight:900;
    color:#fff;
    background:rgba(231,76,60,.95);
    border:3px solid #fff;
    box-shadow:0 12px 30px rgba(0,0,0,.35);
    z-index:100;
    opacity:0;
    transform:scale(.98);
    transition:opacity .18s ease, transform .18s ease;
    pointer-events:none;
  }
  .overlay-visible{opacity:1; transform:scale(1)}
  .success-overlay{background:rgba(46,204,113,.95)!important}
  .note{font-size:.78rem;color:#556}
</style>
</head>
<body>
  <div class="sidebar">
    <div>
      <h2>‚öôÔ∏è Simulador NR-35 T√©cnico</h2>
      <div class="subtitle">C√°lculos conforme pr√°tica da norma</div>
    </div>

    <div class="alert-box">
      ‚ö†Ô∏è <strong>F√≥rmula:</strong> ZLQ = DQ + DEC + EL + BODY + S + MG(fq)<br>
      <small>Par√¢metros: S=1,0 m; MG(fq)=<b>0</b> se FQ=0, sen√£o <b>0,5 m</b>. DQ = FQ√óL.</small>
    </div>

    <div class="control-group">
      <label>1. Altura de Trabalho (H)</label>
      <span id="val-height" class="val-display">6.0m</span>
      <input type="range" id="input-height" min="2.0" max="12.0" step="0.5" value="6.0">
      <div class="hint">Altura dos p√©s do trabalhador em rela√ß√£o ao solo</div>
    </div>

    <!-- Altura do trabalhador FIXA (1,65 m) -->
    <div class="control-group">
      <label>2. Altura do Trabalhador</label>
      <span class="val-display">1.65m</span>
      <div class="hint">Valor fixo para este simulador</div>
    </div>

    <div class="control-group">
      <label>3. Comprimento Talabarte (L)</label>
      <span id="val-l" class="val-display">1.50m</span>
      <input type="range" id="input-l" min="0.8" max="2.0" step="0.1" value="1.5">
      <div class="hint">Comprimento do dispositivo de conex√£o</div>
    </div>

    <div class="control-group">
      <label>4. Absorvedor de Energia (DEC)</label>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <input type="checkbox" id="chk-dec" checked>
        <label for="chk-dec" style="margin:0">Usar absorvedor</label>
        <span id="val-dec" class="val-display">1.20m</span>
      </div>
      <input type="range" id="input-dec" min="0.60" max="1.80" step="0.05" value="1.20">
      <div class="hint">Deforma√ß√£o m√°xima do absorvedor sob carga</div>
    </div>

    <div class="control-group">
      <label>5. Elasticidade do Sistema (EL)</label>
      <span id="val-el" class="val-display">15%</span>
      <input type="range" id="input-el" min="5" max="25" step="1" value="15">
      <div class="hint">Alongamento da corda/cabo aplicado sobre (L + DEC)</div>
    </div>

    <div class="control-group">
      <label>6. Posi√ß√£o da Ancoragem (Fator de Queda)</label>
      <span id="val-anchor" class="val-display">Acima (FQ‚âà0)</span>
      <input type="range" id="input-anchor" min="0" max="2" step="1" value="0">
      <div class="hint">0: Acima (FQ‚âà0) | 1: Altura cinto (FQ=1) | 2: P√©s (FQ=2)</div>
    </div>

    <!-- KPIs -->
    <div class="kpi-panel">
      <div class="kpi-box">
        <div class="kpi-title">Margem de Seguran√ßa (H - ZLQ)</div>
        <div class="kpi-value" id="kpi-zlq-res">-- m</div>
        <div class="kpi-status" id="kpi-status">--</div>
        <div class="hint"><strong>Crit√©rio do app:</strong> Seguro quando Margem ‚â• 1,5 m.</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">Componentes da ZLQ</div>
        <div class="kpi-list">
          <div class="kpi-row"><span>Talabarte (L)</span><strong id="kpi-L">--</strong></div>
          <div class="kpi-row"><span>DQ (Queda Livre = FQ√óL)</span><strong id="kpi-dq">--</strong></div>
          <div class="kpi-row"><span>Absorvedor (DEC)</span><strong id="kpi-dec">--</strong></div>
          <div class="kpi-row"><span>Elasticidade (EL)</span><strong id="kpi-elasticity">--</strong></div>
          <div class="kpi-row"><span>BODY (D-ring‚Üíp√©s)</span><strong id="kpi-body">--</strong></div>
          <div class="kpi-row"><span>Seguran√ßa (S)</span><strong id="kpi-safe">1.00 m</strong></div>
          <div class="kpi-row"><span>Margem Adic. MG(fq)</span><strong id="kpi-mg">--</strong></div>
          <div class="kpi-row" style="border-top:2px solid #ddd;margin-top:4px;padding-top:4px">
            <span><strong>ZLQ Total (soma)</strong></span><strong id="kpi-zlq-req" style="color:#1f5fa6">--</strong>
          </div>
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">üìã Fator de Queda (equivalente)</div>
        <div id="fq-info" style="font-size:.82rem;line-height:1.5;color:#555">--</div>
        <div class="note">Exibido como FQ equivalente ‚â§ 2,00.</div>
      </div>
    </div>

    <button class="btn" id="btn-sim">‚ö†Ô∏è Simular queda</button>
    <button class="btn btn-secondary" id="btn-reset">üîÑ Resetar</button>
  </div>

  <div class="stage-container" id="stage">
    <div id="alert-overlay" aria-live="polite">COLIS√ÉO COM O SOLO!</div>
    <canvas id="simCanvas"></canvas>
  </div>

<script>
/* ==== Constantes ==== */
const PX_RULER_MAX_M = 12.0;
const SAFETY_S = 1.0;               // S
const MARGIN_MG_BASE = 0.5;         // MG base (ser√° 0 se FQ=0)
const DRING_RATIO = 0.77;           // D-ring ~77% da altura
let PX_PER_METER = 50;

const canvas=document.getElementById('simCanvas'), ctx=canvas.getContext('2d');
let running=false, finished=false;

let world={groundY:0}, anchor={x:0,y:0,fq:0};
let worker={x:0,y:0,startY:0,heightM:1.65,heightPx:0};  // ALTURA FIXA 1,65 m
let rope={lengthM:1.5};
let config={workHeightM:6.0,useDecel:true,decelM:1.20,elasticityPerc:15};

let lastMargin=0, lastComponents=null, lastGuideBounds=null;

/* ==== DOM ==== */
const inH=document.getElementById('input-height');
const inL=document.getElementById('input-l');
const inDecOn=document.getElementById('chk-dec');
const inDec=document.getElementById('input-dec');
const inEl=document.getElementById('input-el');
const inAnchor=document.getElementById('input-anchor');

const vH=document.getElementById('val-height');
const vL=document.getElementById('val-l');
const vDec=document.getElementById('val-dec');
const vEl=document.getElementById('val-el');
const vAnchor=document.getElementById('val-anchor');

const kL=document.getElementById('kpi-L');
const kDQ=document.getElementById('kpi-dq');
const kDEC=document.getElementById('kpi-dec');
const kEL=document.getElementById('kpi-elasticity');
const kBODY=document.getElementById('kpi-body');
const kSAFE=document.getElementById('kpi-safe');
const kMG=document.getElementById('kpi-mg');
const kREQ=document.getElementById('kpi-zlq-req');
const kRES=document.getElementById('kpi-zlq-res');
const kSTAT=document.getElementById('kpi-status');
const fqInfo=document.getElementById('fq-info');

document.getElementById('btn-sim').addEventListener('click',startSimulation);
document.getElementById('btn-reset').addEventListener('click',resetSimulation);
[inH,inL,inDecOn,inDec,inEl,inAnchor].forEach(el=>el.addEventListener('input',updateSettings));

/* ==== Utilit√°rios de c√°lculo ==== */
function calcBODY(h){ return +(h * DRING_RATIO).toFixed(2); }

/* ITEM 1/3 ‚Äî DQ sem BODY; DQ = FQ √ó L; se FQ=0, DQ=0 (MG ser√° 0) */
function calcDQ(fq, L){
  if (fq === 0) return 0.0;
  if (fq === 1) return 1.0 * L;
  if (fq === 2) return 2.0 * L;
  return 0.0;
}

function calcKPIs(){
  const H = parseFloat(inH.value);
  const L = parseFloat(inL.value);
  const useDec = inDecOn.checked;
  const DEC = useDec ? parseFloat(inDec.value) : 0.0;
  const elastPerc = parseFloat(inEl.value);
  const fq = parseInt(inAnchor.value);

  worker.heightM = 1.65; // fixo
  const BODY = calcBODY(worker.heightM);
  const EL = (L + DEC) * (elastPerc / 100);
  const DQ = calcDQ(fq, L);

  /* ITEM 3 ‚Äî MG din√¢mico: se FQ=0 ‚áí MG=0; sen√£o MG=0,5 */
  const MG = (fq === 0 ? 0.0 : MARGIN_MG_BASE);

  const ZLQreq = +(DQ + DEC + EL + BODY + SAFETY_S + MG).toFixed(2);
  const Margin = +(H - ZLQreq).toFixed(2);

  lastMargin = Margin;
  lastComponents = {L, DQ, DEC, EL, BODY, S: SAFETY_S, MG, REQ: ZLQreq, FQ: fq};

  kL.innerText   = L.toFixed(2) + ' m';
  kDQ.innerText  = DQ.toFixed(2) + ' m';
  kDEC.innerText = DEC.toFixed(2) + ' m';
  kEL.innerText  = EL.toFixed(2) + ' m';
  kBODY.innerText= BODY.toFixed(2) + ' m';
  kSAFE.innerText= SAFETY_S.toFixed(2) + ' m';
  kMG.innerText  = MG.toFixed(2) + ' m';
  kREQ.innerText = ZLQreq.toFixed(2) + ' m';

  kRES.innerText = (Margin >= 0 ? '+' : '') + Margin.toFixed(2) + ' m';
  if(Margin >= 1.5){ 
    kRES.className = 'kpi-value ok'; 
    kSTAT.className = 'kpi-status ok'; 
    kSTAT.innerText = '‚úì SEGURO (Margem ‚â• 1,5 m)'; 
  } else if(Margin >= 0){ 
    kRES.className = 'kpi-value warn'; 
    kSTAT.className = 'kpi-status warn'; 
    kSTAT.innerText = '‚ö† MARGEM INSUFICIENTE (0 ‚Äì 1,5 m)'; 
  } else { 
    kRES.className = 'kpi-value bad'; 
    kSTAT.className = 'kpi-status bad'; 
    kSTAT.innerText = '‚úó COLIS√ÉO IMINENTE (Margem negativa)'; 
  }

  /* ITEM 2 ‚Äî FQ equivalente limitado a 2,00 */
  const fqRaw = L > 0 ? (DQ / L) : 0;
  const fqEq = Math.min(Math.max(fqRaw, 0), 2).toFixed(2);
  let fqDesc = '';
  if(fq === 0) fqDesc = '<strong>FQ‚âà0:</strong> Ancoragem acima da cabe√ßa. Queda livre m√≠nima. (MG=0)';
  else if(fq === 1) fqDesc = '<strong>FQ=1:</strong> Ancoragem na altura do cinto. Queda livre ‚âà L.';
  else fqDesc = '<strong>FQ=2:</strong> Ancoragem na altura dos p√©s. Queda livre ‚âà 2√óL.';
  fqInfo.innerHTML = `${fqDesc}<br><small>Fator de Queda <em>equivalente</em>: <strong>${fqEq}</strong> (limite 2,00)</small>`;
}

/* ==== Atualiza√ß√£o/posicionamento ==== */
function updateSettings(){
  config.workHeightM = parseFloat(inH.value);
  rope.lengthM       = parseFloat(inL.value);
  config.useDecel    = inDecOn.checked;
  config.decelM      = parseFloat(inDec.value);
  config.elasticityPerc = parseFloat(inEl.value);
  anchor.fq          = parseInt(inAnchor.value);

  vH.innerText    = config.workHeightM.toFixed(1)+'m';
  vL.innerText    = rope.lengthM.toFixed(2)+'m';
  vDec.innerText  = config.decelM.toFixed(2)+'m';
  vEl.innerText   = config.elasticityPerc + '%';
  vAnchor.innerText = ['Acima (FQ‚âà0)','Altura cinto (FQ=1)','P√©s (FQ=2)'][anchor.fq];

  worker.heightPx = worker.heightM * PX_PER_METER;

  if(!running){
    const feetY = world.groundY - (config.workHeightM * PX_PER_METER);
    worker.y = feetY - worker.heightPx;
    worker.x = canvas.width / 2;
    worker.startY = worker.y;

    const BODY = calcBODY(worker.heightM);
    const dRingY = feetY - (BODY * PX_PER_METER);
    if(anchor.fq === 0) anchor.y = dRingY - (1.5 * PX_PER_METER);  // acima
    else if(anchor.fq === 1) anchor.y = dRingY;                     // cinto
    else anchor.y = feetY;                                          // p√©s
    anchor.x = worker.x - 30;
  }

  calcKPIs();
  if(!running) drawScene();
}

/* ==== Canvas/scene ==== */
function resize(){
  canvas.width = document.getElementById('stage').offsetWidth;
  canvas.height= document.getElementById('stage').offsetHeight;
  world.groundY = canvas.height - 40;
  PX_PER_METER = (world.groundY - 40) / PX_RULER_MAX_M;
  resetSimulation();
}
window.addEventListener('resize', resize);

function drawScene(){
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawRulers();

  const feetY0 = world.groundY - (config.workHeightM * PX_PER_METER);
  ctx.beginPath(); 
  ctx.moveTo(0, feetY0); 
  ctx.lineTo(canvas.width, feetY0);
  ctx.strokeStyle = "#bdc3c7"; 
  ctx.lineWidth = 4; 
  ctx.setLineDash([10, 10]); 
  ctx.stroke(); 
  ctx.setLineDash([]);
  ctx.fillStyle = "#7f8c8d"; 
  ctx.font = "bold 12px Inter"; 
  ctx.fillText("PLATAFORMA DE TRABALHO", 10, feetY0 - 6);

  ctx.fillStyle = "#5d4037"; 
  ctx.fillRect(0, world.groundY, canvas.width, canvas.height - world.groundY);
  ctx.fillStyle = "#8d6e63"; 
  ctx.fillRect(0, world.groundY, canvas.width, 5);
  ctx.fillStyle = "rgba(255,255,255,.35)"; 
  ctx.fillText("SOLO (N√çVEL 0)", canvas.width / 2 - 40, world.groundY + 24);

  const BODY = calcBODY(worker.heightM);
  const dRingY = (worker.y + worker.heightPx) - (BODY * PX_PER_METER);

  /* Corda base */
  const dx = worker.x - anchor.x, dy = dRingY - anchor.y;
  const dist = Math.hypot(dx, dy);

  ctx.beginPath(); 
  ctx.moveTo(anchor.x, anchor.y); 
  ctx.lineTo(worker.x, dRingY);
  ctx.strokeStyle = '#f39c12';
  ctx.lineWidth = 3; 
  ctx.stroke();

  /* ITEM 6 ‚Äî Segmentos L/DEC/EL no estado final */
  if (finished) {
    const Lm = rope.lengthM;
    const DECm = config.useDecel ? config.decelM : 0;
    const ELm = (Lm + DECm) * (config.elasticityPerc / 100);
    const totalM = Lm + DECm + ELm;
    if (totalM > 0 && dist > 0) {
      const ux = dx / dist, uy = dy / dist;
      const pxPerM = dist / totalM;
      const segs = [
        {m: Lm,   color: '#f39c12', label:'L'},
        {m: DECm, color: '#e67e22', label:'DEC'},
        {m: ELm,  color: '#9b59b6', label:'EL'}
      ];
      let accPx = 0;
      segs.forEach(s=>{
        const segPx = s.m * pxPerM;
        ctx.beginPath();
        ctx.moveTo(anchor.x + ux*accPx, anchor.y + uy*accPx);
        ctx.lineTo(anchor.x + ux*(accPx+segPx), anchor.y + uy*(accPx+segPx));
        ctx.strokeStyle = s.color; 
        ctx.lineWidth = 4; 
        ctx.setLineDash([6,4]); 
        ctx.stroke(); 
        ctx.setLineDash([]);
        accPx += segPx;
      });
    }
  }

  /* Ancoragem */
  ctx.beginPath(); 
  ctx.arc(anchor.x, anchor.y, 6, 0, Math.PI * 2); 
  ctx.fillStyle = "#2980b9"; 
  ctx.fill();
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 2;
  ctx.stroke();

  /* Trabalhador */
  ctx.save(); 
  ctx.translate(worker.x, worker.y);
  const wH = worker.heightPx;
  ctx.fillStyle = "#3498db"; 
  ctx.fillRect(-wH * 0.12, wH * 0.22, wH * 0.24, wH * 0.42);
  ctx.fillStyle = "#2c3e50"; 
  ctx.fillRect(-wH * 0.13, wH * 0.33, wH * 0.26, wH * 0.08);
  ctx.fillStyle = "#34495e"; 
  ctx.fillRect(-wH * 0.10, wH * 0.64, wH * 0.10, wH * 0.36);
  ctx.fillRect(wH * 0.00,  wH * 0.64, wH * 0.10, wH * 0.36);
  ctx.fillStyle = "#f1c40f"; 
  ctx.beginPath(); 
  ctx.arc(0, wH * 0.10, wH * 0.12, 0, Math.PI * 2); 
  ctx.fill();
  ctx.fillStyle = "#e74c3c"; 
  ctx.beginPath(); 
  ctx.arc(0, wH * 0.08, wH * 0.13, Math.PI, 0); 
  ctx.fill();
  /* D-ring visual */
  ctx.strokeStyle = "#c0392b";
  ctx.lineWidth = 3;
  const dRingOffset = wH * (1 - DRING_RATIO);
  ctx.beginPath();
  ctx.arc(0, dRingOffset, wH * 0.06, 0, Math.PI * 2);
  ctx.stroke();
  ctx.restore();
}

function drawRulers(){
  const meters = Math.ceil(canvas.height / PX_PER_METER);
  ctx.strokeStyle = "rgba(0,0,0,0.05)"; 
  ctx.lineWidth = 1;
  ctx.fillStyle = "rgba(0,0,0,0.35)"; 
  ctx.font = "10px Inter";
  for(let i = 0; i <= meters; i++){
    const y = world.groundY - (i * PX_PER_METER); 
    if(y < 0) break;
    ctx.beginPath(); 
    ctx.moveTo(0, y); 
    ctx.lineTo(canvas.width, y); 
    ctx.stroke();
    if(i > 0) ctx.fillText(i + "m", canvas.width - 28, y + 3);
  }
}

/* ==== Cotas acumuladas (ZLQ) ==== */
function drawZLQGuides(){
  if(!lastComponents) return;
  const comp = lastComponents;
  let currentY = anchor.y;
  const xPos = worker.x + 70;
  let acum = 0;

  function dim(label, val, color){
    const hPx = val * PX_PER_METER; 
    if(hPx < 2) return;
    ctx.beginPath();
    ctx.moveTo(xPos, currentY); 
    ctx.lineTo(xPos, currentY + hPx);
    ctx.moveTo(xPos - 5, currentY); 
    ctx.lineTo(xPos + 5, currentY);
    ctx.moveTo(xPos - 5, currentY + hPx); 
    ctx.lineTo(xPos + 5, currentY + hPx);
    ctx.strokeStyle = color; 
    ctx.lineWidth = 2; 
    ctx.stroke();
    acum += val;
    ctx.fillStyle = color; 
    ctx.font = "bold 10px Inter";
    ctx.fillText(`${label}: ${val.toFixed(2)}m | Œ£=${acum.toFixed(2)}m`, xPos + 10, currentY + hPx / 2 + 4);
    currentY += hPx;
  }

  if(comp.DQ > 0) dim("DQ (FQ√óL)", comp.DQ, "#e67e22");
  if(comp.DEC> 0) dim("DEC", comp.DEC, "#9b59b6");
  if(comp.EL > 0) dim("EL",  comp.EL,  "#3498db");
  dim("BODY", comp.BODY, "#34495e");
  dim("S",    comp.S,    "#2ecc71");
  if(comp.MG > 0) dim("MG", comp.MG, "#27ae60");

  ctx.beginPath(); 
  ctx.moveTo(xPos - 20, currentY); 
  ctx.lineTo(xPos + 200, currentY);
  ctx.strokeStyle = "#e74c3c"; 
  ctx.lineWidth = 3;
  ctx.setLineDash([5, 5]); 
  ctx.stroke(); 
  ctx.setLineDash([]);
  ctx.fillStyle = "#e74c3c"; 
  ctx.font = "bold 12px Inter";
  ctx.fillText(`ZLQ Total = ${comp.REQ.toFixed(2)} m`, xPos + 10, currentY + 18);

  lastGuideBounds = { x1: xPos - 20, y1: anchor.y, x2: xPos + 200, y2: currentY + 25 };
}

/* ==== Overlay: n√£o sobrepor cotas ==== */
function rectsOverlap(a, b){
  return !(a.x2 < b.x1 || b.x2 < a.x1 || a.y2 < b.y1 || b.y2 < a.y1);
}
function placeOverlaySafely(){
  const overlay = document.getElementById('alert-overlay');
  const stage = document.getElementById('stage');
  const W = stage.clientWidth, H = stage.clientHeight;
  overlay.style.left = overlay.style.right = overlay.style.top = overlay.style.bottom = '';
  overlay.classList.remove('overlay-visible');
  overlay.style.opacity = 0;
  const ow = overlay.offsetWidth || 300;
  const oh = overlay.offsetHeight || 70;
  const M = 15;
  const candidates = [
    {x1: W - M - ow, y1: H - M - oh}, // bottom-right
    {x1: W - M - ow, y1: M},          // top-right
    {x1: M, y1: H - M - oh},          // bottom-left
    {x1: M, y1: M}                    // top-left
  ];
  let chosen = candidates[0];
  if(lastGuideBounds){
    const gb = lastGuideBounds;
    for(const c of candidates){
      const r = {x1: c.x1, y1: c.y1, x2: c.x1 + ow, y2: c.y1 + oh};
      if(!rectsOverlap(gb, r)){ chosen = c; break; }
    }
  }
  overlay.style.left = chosen.x1 + 'px';
  overlay.style.top = chosen.y1 + 'px';
}

/* ==== Simula√ß√£o (ajuste vertical coerente com a margem) ==== */
function startSimulation(){
  if(running) return;
  updateSettings();
  running = true; 
  finished = false;
  
  const overlay = document.getElementById('alert-overlay');
  overlay.className = '';
  overlay.style.opacity = 0;

  const safe = (lastMargin >= 0);
  if(safe){
    overlay.textContent = (lastMargin >= 1.5) ? '‚úì QUEDA AMPARADA COM SEGURAN√áA' : '‚ö† QUEDA AMPARADA (MARGEM BAIXA)';
    overlay.classList.add('success-overlay');
  } else {
    overlay.textContent = '‚úó COLIS√ÉO COM O SOLO!';
  }

  const targetFeetClearM = Math.max(lastMargin, 0);
  const targetFeetY = world.groundY - (targetFeetClearM * PX_PER_METER);
  const targetY = targetFeetY - worker.heightPx;

  const steps = 40; 
  let t = 0; 
  const startY = worker.y;
  (function anim(){
    if(!running) return;
    t++; 
    const p = Math.min(1, t / steps);
    const easeP = 1 - Math.pow(1 - p, 3);
    worker.y = startY + (targetY - startY) * easeP;
    drawScene();
    if(p < 1){ 
      requestAnimationFrame(anim); 
    } else {
      finished = true; 
      running = false;
      drawZLQGuides();
      placeOverlaySafely();
      requestAnimationFrame(() => {
        document.getElementById('alert-overlay').classList.add('overlay-visible');
      });
    }
  })();
}

function resetSimulation(){
  running = false; 
  finished = false;
  lastGuideBounds = null;
  const overlay = document.getElementById('alert-overlay');
  overlay.className = '';
  overlay.style.opacity = 0;
  updateSettings();
}

/* ==== Boot ==== */
function boot(){
  canvas.width = document.getElementById('stage').offsetWidth;
  canvas.height= document.getElementById('stage').offsetHeight;
  world.groundY = canvas.height - 40;
  PX_PER_METER = (world.groundY - 40) / PX_RULER_MAX_M;
  updateSettings();
}
window.addEventListener('load', boot);
window.addEventListener('resize', () => { 
  lastGuideBounds = null; 
  resize(); 
});
</script>

</body>
</html>
