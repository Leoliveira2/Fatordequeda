<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Simulador NR-35 ‚Äî ZLQ alinhada (DQ/L/DEC/EL/BODY/S)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
  :root{
    --cor-fundo:#eef2f6; --cor-painel:#fff;
    --cor-seguro:#2ecc71; --cor-atencao:#f1c40f; --cor-critico:#e74c3c;
    --cor-corda:#f39c12; --cor-texto:#2c3e50;
  }
  *{box-sizing:border-box}
  body{font-family:'Inter',sans-serif;background:var(--cor-fundo);margin:0;padding:20px;height:100vh;overflow:hidden;display:flex;gap:20px;color:var(--cor-texto)}
  .sidebar{width:360px;background:var(--cor-painel);padding:18px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1);display:flex;flex-direction:column;gap:14px;z-index:10;overflow-y:auto}
  h2{margin:0 0 6px;font-size:1.15rem;color:#2c3e50}
  .subtitle{font-size:.8rem;color:#7f8c8d;margin-bottom:6px}
  .alert-box{background:#fff3cd;border:2px solid #f39c12;border-radius:8px;padding:10px;margin-bottom:10px;font-size:.82rem;color:#856404}
  .control-group{border-bottom:1px solid #eee;padding-bottom:10px;margin-bottom:6px}
  label{font-size:.86rem;font-weight:700;color:#34495e;display:block;margin-bottom:6px}
  input[type="range"]{width:100%;margin:3px 0 6px;cursor:pointer}
  .val-display{font-size:.9rem;font-weight:900;color:#1f5fa6;float:right}
  .hint{color:#7f8c8d;font-size:.74rem;margin-top:4px}
  .btn{padding:14px;border:none;border-radius:10px;font-weight:900;cursor:pointer;transition:transform .1s,box-shadow .2s,color .2s;background:#2563eb;color:#fff;text-transform:uppercase}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(37,99,235,.25)}
  .btn-secondary{background:#95a5a6}
  .btn-ghost{background:#e5e7eb;color:#111}
  .kpi-panel{display:grid;grid-template-columns:1fr;gap:10px}
  .kpi-box{background:#f8f9fa;padding:10px;border-radius:8px;border-left:4px solid #e5e7eb}
  .kpi-title{font-size:.68rem;text-transform:uppercase;color:#666;font-weight:800;margin-bottom:6px}
  .kpi-value{font-size:1.2rem;font-weight:900}
  .kpi-status{font-size:.8rem;font-weight:900;margin-top:4px}
  .kpi-list{margin-top:6px}
  .kpi-row{display:flex;justify-content:space-between;font-size:.86rem;padding:3px 0;border-bottom:1px dashed #e5e7eb}
  .kpi-row:last-child{border-bottom:none}
  .ok{color:var(--cor-seguro)} .warn{color:var(--cor-atencao)} .bad{color:var(--cor-critico)}
  .stage-container{flex:1;background:linear-gradient(to bottom,#87CEEB 0%,#e0f7fa 100%);border-radius:12px;position:relative;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.1);border:2px solid #fff}
  canvas{position:absolute;inset:0;width:100%;height:100%;z-index:2}
  #alert-overlay{
    position:absolute;padding:14px 18px;border-radius:12px;font-size:1.05rem;font-weight:900;color:#fff;
    background:rgba(231,76,60,.95);border:3px solid #fff;box-shadow:0 12px 30px rgba(0,0,0,.35);
    z-index:100;opacity:0;transform:scale(.98);transition:opacity .18s ease, transform .18s ease;pointer-events:none;
  }
  .overlay-visible{opacity:1; transform:scale(1)}
  .success-overlay{background:rgba(46,204,113,.95)!important}
  /* Avan√ßados */
  #advanced{display:none;background:#fdfdfd;border:1px dashed #d1d5db;border-radius:10px;padding:10px}
  #btn-adv.active{background:#1f2937;color:#fff}
</style>
</head>
<body>
  <div class="sidebar">
    <div>
      <h2>‚öôÔ∏è Simulador NR-35 T√©cnico</h2>
      <div class="subtitle">ZLQ com cotas fi√©is ao cen√°rio</div>
    </div>

    <div class="alert-box">
      <strong>F√≥rmula:</strong> ZLQ = DQ + DEC + EL + BODY + S<br>
      <small>Assuntos-chave: DQ depende do FQ; BODY = 1,50 m; S = 1,0 m.</small>
    </div>

    <div class="control-group">
      <label>1. Altura de Trabalho (H)</label>
      <span id="val-height" class="val-display">6.0m</span>
      <input type="range" id="input-height" min="2.0" max="12.0" step="0.5" value="6.0">
      <div class="hint">Altura dos p√©s do trabalhador at√© o solo</div>
    </div>

    <div class="control-group">
      <label>2. Comprimento Talabarte (L)</label>
      <span id="val-l" class="val-display">1.50m</span>
      <input type="range" id="input-l" min="0.8" max="2.0" step="0.1" value="1.5">
    </div>

    <div class="control-group">
      <label>3. Absorvedor de Energia (DEC)</label>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <input type="checkbox" id="chk-dec" checked>
        <label for="chk-dec" style="margin:0">Usar absorvedor</label>
        <span id="val-dec" class="val-display">1.20m</span>
      </div>
      <input type="range" id="input-dec" min="0.60" max="1.80" step="0.05" value="1.20">
      <div class="hint">O usu√°rio decide usar ou n√£o. O app apenas calcula.</div>
    </div>

    <div class="control-group">
      <label>4. Posi√ß√£o da Ancoragem (Fator de Queda)</label>
      <span id="val-anchor" class="val-display">Acima (FQ‚âà0)</span>
      <input type="range" id="input-anchor" min="0" max="2" step="1" value="0">
      <div class="hint">0: acima da cabe√ßa | 1: altura do cinto | 2: n√≠vel dos p√©s</div>
    </div>

    <button id="btn-adv" class="btn btn-ghost">‚öôÔ∏è Campos avan√ßados</button>
    <div id="advanced">
      <div class="control-group" style="border:none;margin:0 0 6px 0">
        <label>Altura do Trabalhador (visual)</label>
        <span id="val-worker-h" class="val-display">1.65m</span>
        <input type="range" id="input-worker-h" min="1.55" max="1.95" step="0.05" value="1.65">
        <div class="hint">Apenas visual. Para os c√°lculos, BODY = 1,50 m</div>
      </div>
      <div class="control-group" style="border:none;margin:0">
        <label>Elasticidade do Sistema (EL)</label>
        <span id="val-el" class="val-display">15%</span>
        <input type="range" id="input-el" min="5" max="25" step="1" value="15">
        <div class="hint">Aplicada sobre (L + DEC)</div>
      </div>
    </div>

    <div class="kpi-panel">
      <div class="kpi-box">
        <div class="kpi-title">Margem de Seguran√ßa (H ‚àí ZLQ)</div>
        <div class="kpi-value" id="kpi-zlq-res">-- m</div>
        <div class="kpi-status" id="kpi-status">--</div>
        <div class="hint">Crit√©rio: <strong>Seguro</strong> quando Margem ‚â• <strong>1,0 m</strong>.</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">Componentes da ZLQ</div>
        <div class="kpi-list">
          <div class="kpi-row"><span>Talabarte (L)</span><strong id="kpi-L">--</strong></div>
          <div class="kpi-row"><span>DQ (ver FQ)</span><strong id="kpi-dq">--</strong></div>
          <div class="kpi-row"><span>DEC (Absorvedor)</span><strong id="kpi-dec">--</strong></div>
          <div class="kpi-row"><span>EL (Elasticidade)</span><strong id="kpi-elasticity">--</strong></div>
          <div class="kpi-row"><span>BODY (D-ring‚Üíp√©s)</span><strong id="kpi-body">1.50 m</strong></div>
          <div class="kpi-row"><span>S (Seguran√ßa)</span><strong id="kpi-safe">1.00 m</strong></div>
          <div class="kpi-row" style="border-top:2px solid #ddd;margin-top:4px;padding-top:4px">
            <span><strong>ZLQ Total</strong></span><strong id="kpi-zlq-req" style="color:#1f5fa6">--</strong>
          </div>
        </div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">üìã Fator de Queda</div>
        <div id="fq-info" style="font-size:.82rem;line-height:1.5;color:#555">--</div>
      </div>
    </div>

    <button class="btn" id="btn-sim">‚ö†Ô∏è Simular queda</button>
    <button class="btn btn-secondary" id="btn-reset">üîÑ Resetar</button>
  </div>

  <div class="stage-container" id="stage">
    <div id="alert-overlay" aria-live="polite">COLIS√ÉO COM O SOLO!</div>
    <canvas id="simCanvas"></canvas>
  </div>

<script>
/* ==== Constantes e estado ==== */
const PX_RULER_MAX_M = 12.0;
const SAFETY_S = 1.0;
const BODY_CONST = 1.5;       // D-ring ‚Üí p√©s fixo em 1,50 m (c√°lculo e cotas)
let PX_PER_METER = 50;

const canvas = document.getElementById('simCanvas');
const ctx    = canvas.getContext('2d');
let running=false, finished=false;

let world={groundY:0}, anchor={x:0,y:0,fq:0};
let worker={x:0,y:0,startY:0,heightM:1.65,heightPx:0};
let rope  ={lengthM:1.5};
let config={workHeightM:6.0,useDecel:true,decelM:1.20,elasticityPerc:15};

let lastMargin=0, lastComponents=null, lastGuideBounds=null, lastStartDRingY=null;

/* ==== DOM ==== */
const inH=document.getElementById('input-height');
const inL=document.getElementById('input-l');
const inDecOn=document.getElementById('chk-dec');
const inDec=document.getElementById('input-dec');
const inEl=document.getElementById('input-el');
const inAnchor=document.getElementById('input-anchor');
const inWorkerH=document.getElementById('input-worker-h');

const vH=document.getElementById('val-height');
const vL=document.getElementById('val-l');
const vDec=document.getElementById('val-dec');
const vEl=document.getElementById('val-el');
const vAnchor=document.getElementById('val-anchor');
const vWorkerH=document.getElementById('val-worker-h');

const kL=document.getElementById('kpi-L');
const kDQ=document.getElementById('kpi-dq');
const kDEC=document.getElementById('kpi-dec');
const kEL=document.getElementById('kpi-elasticity');
const kREQ=document.getElementById('kpi-zlq-req');
const kRES=document.getElementById('kpi-zlq-res');
const kSTAT=document.getElementById('kpi-status');
const fqInfo=document.getElementById('fq-info');

document.getElementById('btn-sim').addEventListener('click',startSimulation);
document.getElementById('btn-reset').addEventListener('click',resetSimulation);
[inH,inL,inDecOn,inDec,inEl,inAnchor,inWorkerH].forEach(el=>el.addEventListener('input',updateSettings));

/* Toggle avan√ßados */
const btnAdv = document.getElementById('btn-adv');
const boxAdv = document.getElementById('advanced');
btnAdv.addEventListener('click',()=>{
  const show = boxAdv.style.display!=='block';
  boxAdv.style.display = show?'block':'none';
  btnAdv.classList.toggle('active', show);
});

/* ==== C√°lculo ==== */
function calcDQ(fq, L){
  // FQ=0: 0 | FQ=1: L | FQ=2: L + 1,50 m (D-ring sobre p√©s fixo)
  if(fq===0) return 0;
  if(fq===1) return L;
  return L + BODY_CONST;
}

function calcKPIs(){
  const H   = parseFloat(inH.value);
  const L   = parseFloat(inL.value);
  const DEC = inDecOn.checked ? parseFloat(inDec.value) : 0.0;
  const EL  = (L + DEC) * (parseFloat(inEl.value)/100);
  const fq  = parseInt(inAnchor.value);

  const DQ  = calcDQ(fq, L);
  const ZLQ = +(DQ + DEC + EL + BODY_CONST + SAFETY_S).toFixed(2);
  const MARG= +(H - ZLQ).toFixed(2);

  lastMargin = MARG;
  lastComponents = {L, DQ, DEC, EL, BODY:BODY_CONST, S:SAFETY_S, REQ:ZLQ, FQ:fq};

  kL.innerText   = L.toFixed(2)+' m';
  kDQ.innerText  = DQ.toFixed(2)+' m';
  kDEC.innerText = DEC.toFixed(2)+' m';
  kEL.innerText  = EL.toFixed(2)+' m';
  kREQ.innerText = ZLQ.toFixed(2)+' m';

  kRES.innerText = (MARG>=0?'+':'')+MARG.toFixed(2)+' m';
  if(MARG>=1.0){ kRES.className='kpi-value ok';   kSTAT.className='kpi-status ok';   kSTAT.innerText='‚úì SEGURO (Margem ‚â• 1,0 m)'; }
  else if(MARG>=0){ kRES.className='kpi-value warn'; kSTAT.className='kpi-status warn'; kSTAT.innerText='‚ö† MARGEM < 1,0 m'; }
  else { kRES.className='kpi-value bad';  kSTAT.className='kpi-status bad';  kSTAT.innerText='‚úó COLIS√ÉO (Margem negativa)'; }

  // Info FQ
  let desc='';
  if(fq===0) desc='<strong>FQ‚âà0:</strong> ancoragem acima; queda livre m√≠nima.';
  else if(fq===1) desc='<strong>FQ=1:</strong> ancoragem ao n√≠vel do cinto; DQ‚âàL.';
  else desc='<strong>FQ=2:</strong> ancoragem ao n√≠vel dos p√©s; DQ‚âàL + 1,50 m.';
  const fqEq = (L>0?Math.min((DQ/L),2).toFixed(2):'0.00');
  fqInfo.innerHTML = `${desc}<br><small>Fator de queda equivalente: <strong>${fqEq}</strong> (limitado a 2,00)</small>`;
}

/* ==== Atualiza√ß√£o/posicionamento ==== */
function updateSettings(){
  config.workHeightM   = parseFloat(inH.value);
  rope.lengthM         = parseFloat(inL.value);
  config.useDecel      = inDecOn.checked;
  config.decelM        = parseFloat(inDec.value);
  config.elasticityPerc= parseFloat(inEl.value);
  anchor.fq            = parseInt(inAnchor.value);
  worker.heightM       = parseFloat(inWorkerH.value);

  vH.innerText      = config.workHeightM.toFixed(1)+'m';
  vL.innerText      = rope.lengthM.toFixed(2)+'m';
  vDec.innerText    = config.decelM.toFixed(2)+'m';
  vEl.innerText     = config.elasticityPerc+'%';
  vWorkerH.innerText= worker.heightM.toFixed(2)+'m';
  vAnchor.innerText = ['Acima (FQ‚âà0)','Altura do cinto (FQ=1)','P√©s (FQ=2)'][anchor.fq];

  worker.heightPx = worker.heightM * PX_PER_METER;

  if(!running){
    const feetY = world.groundY - (config.workHeightM * PX_PER_METER);
    worker.y = feetY - worker.heightPx;
    worker.x = canvas.width/2;
    worker.startY = worker.y;

    // D-ring inicial = 1,50 m acima dos p√©s (para desenho E c√°lculos)
    const dRingY0 = feetY - (BODY_CONST * PX_PER_METER);
    lastStartDRingY = dRingY0;

    if(anchor.fq===0) anchor.y = dRingY0 - (1.5*PX_PER_METER);  // ancoragem acima ~1,5 m do D-ring
    else if(anchor.fq===1) anchor.y = dRingY0;                   // ao n√≠vel do cinto
    else anchor.y = feetY;                                       // nos p√©s
    anchor.x = worker.x - 30;
  }

  calcKPIs();
  if(!running) drawScene();
}

/* ==== Canvas/scene ==== */
function resize(){
  canvas.width  = document.getElementById('stage').offsetWidth;
  canvas.height = document.getElementById('stage').offsetHeight;
  world.groundY = canvas.height - 40;
  PX_PER_METER  = (world.groundY - 40) / PX_RULER_MAX_M;
  resetSimulation();
}
window.addEventListener('resize', resize);

function drawScene(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawRulers();

  const feetY0 = world.groundY - (config.workHeightM * PX_PER_METER);
  ctx.beginPath(); ctx.moveTo(0,feetY0); ctx.lineTo(canvas.width,feetY0);
  ctx.strokeStyle="#bdc3c7"; ctx.lineWidth=4; ctx.setLineDash([10,10]); ctx.stroke(); ctx.setLineDash([]);
  ctx.fillStyle="#7f8c8d"; ctx.font="bold 12px Inter"; ctx.fillText("PLATAFORMA DE TRABALHO",10,feetY0-6);

  ctx.fillStyle="#5d4037"; ctx.fillRect(0,world.groundY,canvas.width,canvas.height-world.groundY);
  ctx.fillStyle="#8d6e63"; ctx.fillRect(0,world.groundY,canvas.width,5);
  ctx.fillStyle="rgba(255,255,255,.35)"; ctx.fillText("SOLO (N√çVEL 0)", canvas.width/2-40, world.groundY+24);

  // D-ring atual (desenho) baseado no BODY_CONST = 1,50 m
  const dRingY = (worker.y + worker.heightPx) - (BODY_CONST * PX_PER_METER);

  // Corda
  const dx = worker.x - anchor.x, dy = dRingY - anchor.y;
  const dist = Math.hypot(dx,dy);
  ctx.beginPath(); ctx.moveTo(anchor.x,anchor.y); ctx.lineTo(worker.x,dRingY);
  ctx.strokeStyle='#f39c12'; ctx.lineWidth=3; ctx.stroke();

  // Segmenta√ß√£o L/DEC/EL no final
  if(finished){
    const Lm=rope.lengthM, DECm=config.useDecel?config.decelM:0, ELm=(Lm+DECm)*(config.elasticityPerc/100);
    const totalM = Lm + DECm + ELm;
    if(totalM>0 && dist>0){
      const ux=dx/dist, uy=dy/dist;
      const pxPerM = dist/totalM;
      const segs=[ {m:Lm, color:'#f39c12'}, {m:DECm, color:'#e67e22'}, {m:ELm, color:'#9b59b6'} ];
      let acc=0;
      for(const s of segs){
        const segPx=s.m*pxPerM;
        ctx.beginPath();
        ctx.moveTo(anchor.x+ux*acc, anchor.y+uy*acc);
        ctx.lineTo(anchor.x+ux*(acc+segPx), anchor.y+uy*(acc+segPx));
        ctx.strokeStyle=s.color; ctx.lineWidth=4; ctx.setLineDash([6,4]); ctx.stroke(); ctx.setLineDash([]);
        acc+=segPx;
      }
    }
  }

  // Ancoragem
  ctx.beginPath(); ctx.arc(anchor.x,anchor.y,6,0,Math.PI*2); ctx.fillStyle="#2980b9"; ctx.fill();
  ctx.strokeStyle="#fff"; ctx.lineWidth=2; ctx.stroke();

  // Trabalhador
  ctx.save(); ctx.translate(worker.x,worker.y);
  const wH=worker.heightPx;
  ctx.fillStyle="#3498db"; ctx.fillRect(-wH*.12, wH*.22, wH*.24, wH*.42);
  ctx.fillStyle="#2c3e50"; ctx.fillRect(-wH*.13, wH*.33, wH*.26, wH*.08);
  ctx.fillStyle="#34495e"; ctx.fillRect(-wH*.10, wH*.64, wH*.10, wH*.36); ctx.fillRect(wH*0.00, wH*.64, wH*.10, wH*.36);
  ctx.fillStyle="#f1c40f"; ctx.beginPath(); ctx.arc(0, wH*.10, wH*.12, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle="#e74c3c"; ctx.beginPath(); ctx.arc(0, wH*.08, wH*.13, Math.PI, 0); ctx.fill();
  // D-ring visual no ponto correto (1,50 m acima dos p√©s)
  const dRingOffset = wH - (BODY_CONST * PX_PER_METER);
  ctx.strokeStyle="#c0392b"; ctx.lineWidth=3;
  ctx.beginPath(); ctx.arc(0, dRingOffset, wH*.06, 0, Math.PI*2); ctx.stroke();
  ctx.restore();
}

function drawRulers(){
  const meters=Math.ceil(canvas.height/PX_PER_METER);
  ctx.strokeStyle="rgba(0,0,0,0.05)"; ctx.lineWidth=1;
  ctx.fillStyle="rgba(0,0,0,0.35)"; ctx.font="10px Inter";
  for(let i=0;i<=meters;i++){
    const y=world.groundY-(i*PX_PER_METER); if(y<0) break;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
    if(i>0) ctx.fillText(i+"m", canvas.width-28, y+3);
  }
}

/* ==== Cotas (base D-ring inicial) ==== */
function drawZLQGuides(){
  if(!lastComponents || lastStartDRingY==null) return;
  const comp=lastComponents;
  let currentY = lastStartDRingY;         // ponto zero = D-ring antes da queda
  const xPos = worker.x + 70;
  let acum = 0;

  function dim(label, val, color){
    const hPx = val * PX_PER_METER; if(hPx<2) return;
    ctx.beginPath();
    ctx.moveTo(xPos, currentY); ctx.lineTo(xPos, currentY + hPx);
    ctx.moveTo(xPos-5, currentY); ctx.lineTo(xPos+5, currentY);
    ctx.moveTo(xPos-5, currentY + hPx); ctx.lineTo(xPos+5, currentY + hPx);
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.stroke();
    acum += val;
    ctx.fillStyle=color; ctx.font="bold 10px Inter";
    ctx.fillText(`${label}: ${val.toFixed(2)}m | Œ£=${acum.toFixed(2)}m`, xPos+10, currentY + hPx/2 + 4);
    currentY += hPx;
  }

  if(comp.DQ>0) dim("DQ", comp.DQ, "#e67e22");
  if(comp.DEC>0) dim("DEC", comp.DEC, "#9b59b6");
  if(comp.EL>0)  dim("EL",  comp.EL,  "#3498db");
  dim("BODY", comp.BODY, "#34495e");
  dim("S",    comp.S,    "#2ecc71");

  // Linha do ZLQ total (Œ£)
  ctx.beginPath(); ctx.moveTo(xPos-20, currentY); ctx.lineTo(xPos+200, currentY);
  ctx.strokeStyle="#e74c3c"; ctx.lineWidth=3; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
  ctx.fillStyle="#e74c3c"; ctx.font="bold 12px Inter";
  ctx.fillText(`ZLQ Total = ${comp.REQ.toFixed(2)} m`, xPos+10, currentY+18);

  lastGuideBounds = { x1:xPos-20, y1:lastStartDRingY, x2:xPos+200, y2:currentY+25 };
}

/* ==== Overlay sem sobrepor cotas ==== */
function rectsOverlap(a,b){ return !(a.x2<b.x1 || b.x2<a.x1 || a.y2<b.y1 || b.y2<a.y1); }
function placeOverlaySafely(){
  const overlay=document.getElementById('alert-overlay');
  const stage=document.getElementById('stage');
  const W=stage.clientWidth, H=stage.clientHeight;
  overlay.style.left=overlay.style.right=overlay.style.top=overlay.style.bottom='';
  overlay.classList.remove('overlay-visible'); overlay.style.opacity=0;
  const ow=overlay.offsetWidth||300, oh=overlay.offsetHeight||70, M=15;
  const candidates=[ {x1:W-M-ow,y1:H-M-oh},{x1:W-M-ow,y1:M},{x1:M,y1:H-M-oh},{x1:M,y1:M} ];
  let chosen=candidates[0];
  if(lastGuideBounds){
    for(const c of candidates){
      const r={x1:c.x1,y1:c.y1,x2:c.x1+ow,y2:c.y1+oh};
      if(!rectsOverlap(lastGuideBounds,r)){ chosen=c; break; }
    }
  }
  overlay.style.left=chosen.x1+'px'; overlay.style.top=chosen.y1+'px';
}

/* ==== Simula√ß√£o ==== */
function startSimulation(){
  if(running) return;
  updateSettings();
  running=true; finished=false;

  const overlay=document.getElementById('alert-overlay');
  overlay.className=''; overlay.style.opacity=0;

  const safe=(lastMargin>=0);
  overlay.textContent = safe ? (lastMargin>=1.0?'‚úì QUEDA AMPARADA':'‚ö† QUEDA AMPARADA (Margem < 1,0 m)') : '‚úó COLIS√ÉO COM O SOLO!';
  if(safe) overlay.classList.add('success-overlay');

  const targetFeetClearM=Math.max(lastMargin,0);
  const targetFeetY = world.groundY - (targetFeetClearM*PX_PER_METER);
  const targetY = targetFeetY - worker.heightPx;

  const steps=40; let t=0; const startY=worker.y;
  (function anim(){
    if(!running) return;
    t++; const p=Math.min(1,t/steps), ease=1-Math.pow(1-p,3);
    worker.y = startY + (targetY - startY)*ease;
    drawScene();
    if(p<1){ requestAnimationFrame(anim); }
    else{
      finished=true; running=false;
      drawZLQGuides();
      placeOverlaySafely();
      requestAnimationFrame(()=>document.getElementById('alert-overlay').classList.add('overlay-visible'));
    }
  })();
}

function resetSimulation(){
  running=false; finished=false; lastGuideBounds=null;
  const overlay=document.getElementById('alert-overlay');
  overlay.className=''; overlay.style.opacity=0;
  updateSettings();
}

/* ==== Boot ==== */
function boot(){
  canvas.width  = document.getElementById('stage').offsetWidth;
  canvas.height = document.getElementById('stage').offsetHeight;
  world.groundY = canvas.height - 40;
  PX_PER_METER  = (world.groundY - 40) / PX_RULER_MAX_M;
  updateSettings();
}
window.addEventListener('load', boot);
window.addEventListener('resize', ()=>{ lastGuideBounds=null; resize(); });
</script>
</body>
</html>
